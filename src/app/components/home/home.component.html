<div class="home">
  <h1>Il nostro catalogo</h1>

  <div *ngIf="products.length === 0" class="empty-state">
    <i class="pi pi-inbox"></i>
    <p>Nessun prodotto aggiunto.</p>
  </div>

  <div class="p-grid p-align-start p-mt-4" *ngIf="products.length > 0">
    <div class="p-col-12 p-sm-6 p-md-4" *ngFor="let product of products; trackBy: trackById">
      <p-card [header]="product.name" styleClass="product-card">
        <!-- Azioni modifica / elimina -->
        <div class="card-actions">
          <button pButton type="button" class="p-button-rounded p-button-text" icon="pi pi-pencil"
            (click)="editProduct(product)"></button>
          <button pButton type="button" class="p-button-rounded p-button-danger p-button-text" icon="pi pi-trash"
            (click)="deleteProduct($event, product)"></button>
        </div>

        <!-- Header con immagine -->
        <ng-template pTemplate="header">
          <div class="product-image-container">
            <ng-container *ngIf="hasProductImage(product.id); else placeholder">
              <img pCardImage [src]="getProductImageUrl(product.id)" [alt]="product.name" class="product-image"
                (error)="onImageError(product.id)" />
            </ng-container>
            <ng-template #placeholder>
              <div class="product-image-placeholder">
                <i class="pi pi-image"></i>
                <span>Nessuna immagine</span>
              </div>
            </ng-template>
          </div>
        </ng-template>

        <!-- Corpo card con descrizione e varianti -->
        <ng-template pTemplate="content">
          <p *ngIf="product.description" class="product-description">
            {{ product.description }}
          </p>

          <h4 class="variants-title">Varianti</h4>
          <ul class="variants-list">
            <li *ngFor="let variant of getProductVariants(product.id)" class="variant-item">
              <div class="variant-header">
                <div class="variant-info">
                  <span class="variant-name">{{ variant.longName }}</span>
                </div>
                <div class="variant-meta">
                  <span class="variant-price">€ {{ variant.price.toFixed(2) }}</span>
                  <small *ngIf="variant.seatsCount" class="variant-seats">
                    {{ variant.seatsCount }} posti
                  </small>
                  <button pButton type="button" class="p-button-text p-button-sm variant-toggle" [icon]="
                      isVariantExpanded(variant.id)
                        ? 'pi pi-chevron-up'
                        : 'pi pi-chevron-down'
                    " (click)="toggleVariantExpansion(variant.id)"></button>
                </div>
              </div>

              <div class="variant-details" *ngIf="isVariantExpanded(variant.id)">
                <div class="variant-detail-row" *ngIf="variant.seatsCount">
                  <strong>Posti:</strong> {{ variant.seatsCount }}
                </div>
                <div class="variant-detail-row" *ngIf="variant.mattressWidth">
                  <strong>Larghezza materasso:</strong>
                  {{ variant.mattressWidth }}cm
                </div>

                <div class="components-section" *ngIf="variant.components?.length">
                  <h5 class="components-title">Componenti:</h5>
                  <div class="components-list">
                    <div class="component-item" *ngFor="let groupedComponent of getGroupedComponents(variant)">
                      <div class="component-header">
                        <span class="component-name">
                          {{ groupedComponent.component.name }} 
                          <span *ngIf="groupedComponent.quantity > 1" class="component-quantity">
                            ×{{ groupedComponent.quantity }}
                          </span>
                        </span>
                        <span class="component-price">€ {{ groupedComponent.totalPrice.toFixed(2) }}</span>
                      </div>
                      <div class="component-details">
                        <div class="component-detail" *ngIf="groupedComponent.component.suppliers?.length">
                          <strong>Fornitori:</strong>
                          <span *ngFor="
                              let supplier of groupedComponent.component.suppliers;
                              let last = last
                            ">
                            {{ supplier.name }}<span *ngIf="!last">, </span>
                          </span>
                        </div>
                        <div class="component-detail" *ngIf="groupedComponent.component.type">
                          <strong>Tipo:</strong>
                          {{ getComponentTypeName(groupedComponent.component.type) }}
                        </div>
                        <div class="component-detail" *ngIf="groupedComponent.quantity > 1">
                          <strong>Prezzo unitario:</strong> € {{ groupedComponent.component.price.toFixed(2) }}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </li>
          </ul>
        </ng-template>

        <!-- Footer con pulsante listino -->
        <ng-template pTemplate="footer">
          <button pButton type="button" label="Genera Listino" (click)="generaListino(product)"></button>
        </ng-template>
      </p-card>
    </div>
  </div>
</div>

<!-- Dialog Selezione Rivestimento -->
<p-dialog appendTo="body" [(visible)]="showRivestimentoDialog" header="Seleziona Rivestimento" [modal]="true"
  [closable]="false" [baseZIndex]="10000" [style]="{ width: '800px', maxHeight: '90vh' }" [draggable]="false"
  [resizable]="false" (onHide)="cancelRivestimento()">
  <div class="p-fluid">
    <div class="field">
      <label for="rivestimento">Rivestimento:</label>
      <p-dropdown id="rivestimento" [options]="availableRivestimenti" [(ngModel)]="selectedRivestimento"
        optionLabel="code" placeholder="Seleziona un rivestimento" [showClear]="true" scrollHeight="300px"
        [filter]="true" filterBy="code" [autoZIndex]="true" [baseZIndex]="10000" appendTo="body">
        <ng-template pTemplate="selectedItem">
          <div *ngIf="selectedRivestimento" class="selected-rivestimento">
            <span class="rivestimento-code">{{ selectedRivestimento.code }}</span>
            <span class="rivestimento-price">€{{ selectedRivestimento.mtPrice }}/mt</span>
          </div>
        </ng-template>
        <ng-template let-rivestimento pTemplate="item">
          <div class="rivestimento-item">
            <span class="rivestimento-code">{{ rivestimento.code }}</span>
            <span class="rivestimento-price">€{{ rivestimento.mtPrice }}/mt</span>
          </div>
        </ng-template>
      </p-dropdown>
    </div>

    <div class="field" *ngIf="selectedRivestimento">
      <label for="meters">Metri di rivestimento:</label>
      <p-inputNumber id="meters" [(ngModel)]="metersOfRivestimento" [min]="0.1" [step]="0.1" suffix=" mt"
        placeholder="Inserisci i metri"></p-inputNumber>
    </div>

    <div class="field" *ngIf="selectedRivestimento && metersOfRivestimento > 0">
      <strong>
        Costo totale rivestimento: €{{ calculateRivestimentoCost().toFixed(2) }}
      </strong>
    </div>
  </div>

  <ng-template pTemplate="footer">
    <button pButton type="button" label="Annulla" class="p-button-danger" (click)="cancelRivestimento()"></button>
    <button pButton type="button" label="Continua" (click)="selectRivestimento()"
      [disabled]="!selectedRivestimento || metersOfRivestimento <= 0"></button>
  </ng-template>
</p-dialog>

<!-- Dialog Configura Ricarico -->
<p-dialog appendTo="body" [(visible)]="showMarkupDialog" header="Configura Ricarico" [modal]="true" [closable]="false"
  [baseZIndex]="10000" [style]="{ width: '450px' }" [draggable]="false" [resizable]="false" (onHide)="cancelMarkup()"
  [dismissableMask]="false" [closeOnEscape]="false">
  <div class="p-fluid">
    <div class="field">
      <label for="markup">Percentuale di ricarico:</label>
      <p-inputNumber id="markup" [(ngModel)]="markupPercentage" [min]="0" [max]="1000" suffix="%"
        placeholder="Inserisci la percentuale"></p-inputNumber>
    </div>

    <div class="field" *ngIf="selectedProduct">
      <h4>Anteprima prezzi ({{ selectedProduct.name }}):</h4>
      <div *ngFor="let variant of getProductVariants(selectedProduct.id)" class="variant-preview">
        <div class="variant-preview-header">
          <strong>{{ variant.longName }}</strong>
        </div>
        <div class="price-breakdown">
          <div>Prezzo base: €{{ variant.price.toFixed(2) }}</div>
          <div>Rivestimento: €{{ calculateRivestimentoCost().toFixed(2) }}</div>
          <div class="total-price">
            <strong>
              Totale con ricarico ({{ markupPercentage }}%): €{{
              ((variant.price + calculateRivestimentoCost()) /
              ((100 - markupPercentage) / 100)).toFixed(2)
              }}
            </strong>
          </div>
        </div>
      </div>
    </div>
  </div>

  <ng-template pTemplate="footer">
    <button pButton type="button" label="Annulla" class="p-button-danger" (click)="cancelMarkup()"></button>
    <button pButton type="button" label="Genera PDF" (click)="generateWithMarkup()"></button>
  </ng-template>
</p-dialog>

<p-toast></p-toast>
<p-confirmDialog [closable]="false"></p-confirmDialog>