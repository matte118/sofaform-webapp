<div class="home">
  <h1>Il nostro catalogo</h1>

  <!-- Stato vuoto -->
  <div *ngIf="products.length === 0" class="empty-state">
    <i class="pi pi-inbox"></i>
    <p>Nessun prodotto aggiunto.</p>
  </div>

  <!-- Griglia prodotti -->
  <div class="p-grid p-align-start p-mt-4" *ngIf="products.length > 0">
    <div class="p-col-12 p-sm-6 p-md-4" *ngFor="let product of products; trackBy: trackById">
      <p-card [header]="product.name" styleClass="product-card">
        <!-- Azioni modifica / elimina -->
        <div class="card-actions">
          <p-button type="button" icon="pi pi-pencil"
            styleClass="p-button-rounded p-button-text p-button transparent-icon-btn"
            (click)="openEditDialog(product, $event)">
          </p-button>

          <p-button type="button" icon="pi pi-trash"
            styleClass="p-button-rounded p-button-text p-button transparent-red-icon"
            (click)="onDeleteClick(product, $event)">
          </p-button>
        </div>

        <!-- Header con immagine -->
        <ng-template pTemplate="header">
          <div class="product-image-container">
            <ng-container *ngIf="hasProductImage(product.id); else placeholder">
              <img pCardImage [src]="getProductImageUrl(product.id)" [alt]="product.name"
                class="product-image fill-space" (error)="onImageError(product.id)" />
            </ng-container>

            <ng-template #placeholder>
              <div class="product-image-placeholder fill-space">
                <i class="pi pi-image"></i>
                <span>Nessuna immagine</span>
              </div>
            </ng-template>
          </div>
        </ng-template>

        <!-- Contenuto card: descrizione e varianti -->
        <ng-template pTemplate="content">
          <p *ngIf="product.description" class="product-description">
            {{ product.description }}
          </p>

          <h4 class="variants-title">Varianti</h4>
          <ul class="variants-list">
            <li *ngFor="let variant of getProductVariants(product.id)" class="variant-item">
              <!-- Intestazione variante -->
              <div class="variant-header">
                <div class="variant-info">
                  <span class="variant-name">{{ getSofaTypeLabel(variant.longName) }}</span>
                  <!-- <span class="variant-pricing-mode" 
                    [class]="isCustomPricingVariant(variant) ? 'custom-pricing' : 'components-pricing'">
                    {{ isCustomPricingVariant(variant) ? 'Custom' : 'Componenti' }}
                  </span> -->
                </div>
                <div class="variant-meta">
                  <span class="variant-price">€ {{ variant.price.toFixed(2) }}</span>
                  <small *ngIf="variant.seatsCount" class="variant-seats">
                    {{ variant.seatsCount }}
                  </small>
                  <button pButton type="button" class="p-button-text p-button-sm variant-toggle"
                    [icon]="isVariantExpanded(variant.id) ? 'pi pi-chevron-up' : 'pi pi-chevron-down'"
                    (click)="toggleVariantExpansion(variant.id)"></button>
                </div>
              </div>

              <!-- Dettagli espansi -->
              <div class="variant-details" *ngIf="isVariantExpanded(variant.id)">
                <div class="variant-detail-row" *ngIf="variant.seatsCount">
                  <strong>Posti:</strong> {{ variant.seatsCount }}
                </div>
                <div class="variant-detail-row" *ngIf="variant.mattressWidth">
                  <strong>Larghezza:</strong>
                  {{ variant.mattressWidth }} cm
                </div>
                <div class="variant-detail-row" *ngIf="variant.depth">
                  <strong>Profondità:</strong>
                  {{ variant.depth }} cm
                </div>
                <div class="variant-detail-row" *ngIf="variant.height">
                  <strong>Altezza:</strong>
                  {{ variant.height }} cm
                </div>
                <div class="variant-detail-row">
                  <strong>Modalità Prezzo:</strong>
                  {{ isCustomPricingVariant(variant) ? 'Prezzo Custom' : 'Calcolato da Componenti' }}
                </div>

                <!-- Componenti - only show if variant has components -->
                <div class="components-section" *ngIf="hasComponentsToShow(variant)">
                  <h5 class="components-title">Componenti:</h5>
                  <div class="components-list">
                    <div class="component-item" *ngFor="let groupedComponent of getGroupedComponents(variant)">
                      <div class="component-header">
                        <span class="component-name">
                          {{ formatComponentName(groupedComponent.component) }}
                          <span *ngIf="groupedComponent.quantity > 1" class="component-quantity">
                            ×{{ groupedComponent.quantity }}
                          </span>
                        </span>
                        <span class="component-price">
                          € {{ groupedComponent.totalPrice.toFixed(2) }}
                        </span>
                      </div>
                      <div class="component-details">
                        <div class="component-detail" *ngIf="groupedComponent.component.supplier">
                          <strong>Fornitore:</strong>
                          {{ groupedComponent.component.supplier.name }}
                        </div>

                        <div class="component-detail"
                          *ngIf="groupedComponent.component.type !== undefined && groupedComponent.component.type !== null">
                          <strong>Tipo:</strong>
                          {{ getComponentTypeName(groupedComponent.component.type) }}
                        </div>
                        <div class="component-detail" *ngIf="groupedComponent.quantity > 1">
                          <strong>Prezzo unitario:</strong>
                          € {{ groupedComponent.component.price.toFixed(2) }}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- No components message for custom pricing -->
                <div class="no-components-message"
                  *ngIf="isCustomPricingVariant(variant) && !hasComponentsToShow(variant)">
                  <p class="p-text-secondary">
                    <i class="pi pi-info-circle"></i>
                    Questa variante utilizza un prezzo personalizzato senza componenti specifici.
                  </p>
                </div>
              </div>
            </li>
          </ul>
        </ng-template>

        <!-- Footer: genera listino -->
        <ng-template pTemplate="footer">
          <p-button type="button" label="Genera Listino" (click)="generaListino(product)"
            styleClass="primary-button"></p-button>
        </ng-template>
      </p-card>
    </div>
  </div>

  <!-- Template modificato: Dialog Configura Rivestimenti con Dropdown per ogni variante -->
  <p-dialog appendTo="body" [(visible)]="showRivestimentoDialog" header="Configura Rivestimenti per Varianti"
    [modal]="true" [closable]="false" [baseZIndex]="10000"
    [style]="{ width: '900px', maxHeight: '90vh', overflow: 'visible' }" styleClass="rivestimenti-config-dialog"
    contentStyleClass="rivestimenti-dialog-content" [draggable]="false" [resizable]="false"
    (onHide)="onRivestimentoHide()">

    <div class="rivestimenti-dialog-body">
      <div class="dialog-content-scrollable">
        <div class="p-fluid" *ngIf="selectedProduct">
          <div class="rivestimento-selection-section">
            <h4>Seleziona rivestimenti per ogni variante</h4>

            <!-- Dropdown per selezionare la variante corrente -->
            <div class="p-field variant-selector-field">
              <label for="variantSelect">Seleziona Variante:</label>
              <p-dropdown id="variantSelect" [options]="getProductVariants(selectedProduct.id)"
                [(ngModel)]="selectedVariantForRivestimento" optionLabel="longName" placeholder="Scegli variante"
                [showClear]="true" appendTo="body" [style]="{ width: '100%' }" styleClass="variant-dropdown">
                <ng-template let-v pTemplate="item">
                  {{ getSofaTypeLabel(v.longName) }}
                </ng-template>
                <ng-template let-v pTemplate="selectedItem">
                  {{ getSofaTypeLabel(v.longName) }}
                </ng-template>
              </p-dropdown>
            </div>

            <!-- Sezione per la variante selezionata -->
            <ng-container *ngIf="selectedVariantForRivestimento">
              <h5 class="variant-title">{{ getSofaTypeLabel(selectedVariantForRivestimento.longName) }}</h5>

              <!-- Multi-select rivestimenti -->
              <div class="field">
                <label>Seleziona rivestimenti:</label>
                <p-multiSelect [options]="availableRivestimenti"
                  [(ngModel)]="variantRivestimentiSelections[selectedVariantForRivestimento.id]" optionLabel="name"
                  placeholder="Seleziona uno o più rivestimenti" [showClear]="true" [filter]="true" filterBy="name,code"
                  display="chip" appendTo="body"
                  (onChange)="onVariantRivestimentiChange(selectedVariantForRivestimento.id, $event.value)"
                  [style]="{ width: '100%' }">
                  <ng-template let-r pTemplate="item">
                    <div class="rivestimento-item">
                      <span class="rivestimento-name">{{ r.name }}</span>
                      <span class="rivestimento-price">€{{ r.mtPrice | number:'1.2-2' }}/mt</span>
                    </div>
                  </ng-template>
                  <ng-template let-r pTemplate="selectedItem">
                    <span class="rivestimento-chip-token">{{ r.name }}</span>
                  </ng-template>
                </p-multiSelect>
              </div>

              <!-- Metratura e subtotali -->
              <div class="selected-rivestimenti"
                *ngIf="getVariantRivestimenti(selectedVariantForRivestimento.id).length">

                <!-- Sezione per applicare metri uniformi -->
                <div class="uniform-meters-section">
                  <h6>Applica metri uguali a tutti i rivestimenti:</h6>
                  <div class="uniform-meters-controls">
                    <p-inputNumber [ngModel]="getUniformMetersForVariant(selectedVariantForRivestimento.id)"
                      (ngModelChange)="setUniformMetersForVariant(selectedVariantForRivestimento.id, $event)"
                      [min]="0.1" [step]="0.1" mode="decimal" [minFractionDigits]="1" [maxFractionDigits]="2"
                      suffix=" mt" placeholder="1.0" [style]="{ width: '140px' }">
                    </p-inputNumber>
                    <p-button type="button" label="Applica a tutti" icon="pi pi-copy" size="small"
                      styleClass="p-button-outlined p-button-sm"
                      (click)="applyUniformMetersToVariant(selectedVariantForRivestimento.id)"
                      [disabled]="!getVariantRivestimenti(selectedVariantForRivestimento.id).length">
                    </p-button>
                  </div>
                </div>

                <h6>Specifica i metri per ogni rivestimento:</h6>
                <div class="rivestimento-meters-row"
                  *ngFor="let r of getVariantRivestimenti(selectedVariantForRivestimento.id)"
                  style="padding-top: 15px;">
                  <div class="meters-label">
                    <span class="rivestimento-name">{{ r.name }}</span>
                    <span class="rivestimento-unit-price"><i>{{ r.mtPrice | number:'1.2-2' }} €/mt</i></span>
                  </div>
                  <p-inputNumber [ngModel]="getVariantRivestimentoMeters(selectedVariantForRivestimento.id, r.id)"
                    (ngModelChange)="setVariantRivestimentoMeters(selectedVariantForRivestimento.id, r.id, $event)"
                    [min]="0.1" [step]="0.1" mode="decimal" [minFractionDigits]="1" [maxFractionDigits]="2" suffix=" mt"
                    placeholder="0.0" [style]="{ width: '140px' }"></p-inputNumber>
                  <div class="subtotal">
                    € {{ (r.mtPrice * getVariantRivestimentoMeters(selectedVariantForRivestimento.id, r.id)) |
                    number:'1.2-2' }}
                  </div>
                </div>
              </div>

              <div class="no-rivestimenti" *ngIf="!getVariantRivestimenti(selectedVariantForRivestimento.id).length">
                <small class="p-text-secondary">Nessun rivestimento selezionato per questa variante</small>
              </div>
            </ng-container>
          </div>
        </div>
      </div>
    </div>

    <div class="select-dialog-footer">
      <button pButton type="button" label="Annulla" icon="pi pi-times" class="btn-dialog-no"
        (click)="cancelRivestimento()"></button>

      <!-- Continua disabilitato finché non tutti le varianti hanno almeno un rivestimento -->
      <button pButton type="button" label="Continua" icon="pi pi-check" class="btn-dialog-yes"
        (click)="confirmRivestimentiSelection()" [disabled]="isContinueDisabled()">
      </button>
    </div>
  </p-dialog>


  <!-- Dialog Materassi Extra (Listino) -->
  <p-dialog [(visible)]="showListinoExtraMattressDialog" header="Extra (Materassi e Meccanismi)" [modal]="true" [closable]="false"
    [baseZIndex]="10000" [style]="{ width: '700px', maxHeight: '90vh' }" [draggable]="false" [resizable]="false">
    <div class="p-fluid">
      <div class="extra-mattress-section">
        <h4 *ngIf="extraMattressesForListino.length === 0"
          style="text-align: center; color: #6c757d; margin-bottom: 1.5rem;">
          Nessun materasso extra configurato
        </h4>

        <div class="extra-mattress-list" *ngIf="extraMattressesForListino.length > 0">
          <div class="extra-mattress-row" *ngFor="let m of extraMattressesForListino; let i = index">
            <div class="mattress-name-field">
              <label>Nome materasso <span class="required-field">*</span></label>
              <input pInputText [(ngModel)]="m.name" placeholder="Es. Materasso Memory" class="full-width" />
            </div>
            <div class="mattress-price-field">
              <label>Prezzo</label>
              <p-inputNumber [(ngModel)]="m.price" mode="currency" currency="EUR" locale="it-IT" placeholder="€0,00"
                [min]="0" [style]="{ width: '100%' }"></p-inputNumber>
            </div>
            <div class="mattress-actions">
              <button pButton type="button" icon="pi pi-trash" class="p-button-danger p-button-outlined"
                (click)="extraMattressesForListino.splice(i,1)" pTooltip="Rimuovi materasso"
                tooltipPosition="top"></button>
            </div>
          </div>
        </div>

        <div class="add-mattress-section">
          <button pButton type="button" label="Aggiungi Materasso" icon="pi pi-plus"
            class="p-button-outlined p-button-primary" (click)="addNewExtraMattressForListino()"></button>
        </div>
      </div>

      <p-divider></p-divider>

      <div class="extra-mattress-section">
        <h4 *ngIf="extraMechanismsForListino.length === 0"
          style="text-align: center; color: #6c757d; margin-bottom: 1.5rem;">
          Nessun meccanismo extra configurato
        </h4>

        <div class="extra-mattress-list" *ngIf="extraMechanismsForListino.length > 0">
          <div class="extra-mattress-row" *ngFor="let mech of extraMechanismsForListino; let i = index">
            <div class="mattress-name-field">
              <label>Nome meccanismo <span class="required-field">*</span></label>
              <input pInputText [(ngModel)]="mech.name" placeholder="Es. Meccanismo elettrico" class="full-width" />
            </div>
            <div class="mattress-price-field">
              <label>Prezzo</label>
              <p-inputNumber [(ngModel)]="mech.price" mode="currency" currency="EUR" locale="it-IT" placeholder="€0,00"
                [min]="0" [style]="{ width: '100%' }"></p-inputNumber>
            </div>
            <div class="mattress-actions">
              <button pButton type="button" icon="pi pi-trash" class="p-button-danger p-button-outlined"
                (click)="extraMechanismsForListino.splice(i,1)" pTooltip="Rimuovi meccanismo"
                tooltipPosition="top"></button>
            </div>
          </div>
        </div>

        <div class="add-mattress-section">
          <button pButton type="button" label="Aggiungi Meccanismo" icon="pi pi-plus"
            class="p-button-outlined p-button-primary" (click)="addNewExtraMechanismForListino()"></button>
        </div>
      </div>
    </div>

    <ng-template pTemplate="footer">
      <button pButton type="button" label="Annulla" icon="pi pi-times" class="btn-dialog-no"
        (click)="cancelExtraMattressListino()"></button>
      <button pButton type="button" label="Continua" icon="pi pi-check" class="btn-dialog-yes"
        (click)="proceedExtraMattressListino()"></button>
    </ng-template>
  </p-dialog>

  <!-- Dialog Configura Ricarico -->
  <p-dialog appendTo="body" [(visible)]="showMarkupDialog" header="Configurazione Listino" [modal]="true"
    [closable]="false" [baseZIndex]="11000" [draggable]="false" [style]="{ width: '800px', maxHeight: '90vh' }"
    [contentStyle]="{ overflow: 'visible', paddingBottom: '4.5rem' }" [resizable]="false" (onHide)="cancelMarkup()"
    [dismissableMask]="false" [closeOnEscape]="false">
    <div class="p-fluid">
      <div class="field">
        <label for="markup">Percentuale di ricarico:</label>
        <p-inputNumber id="markup" [(ngModel)]="markupPercentage" [min]="0" [max]="1000" suffix="%"
          placeholder="Inserisci la percentuale"></p-inputNumber>
      </div>

      <!-- Selezione Immagine Header -->
      <div class="field">
        <label for="headerImageSelect">Immagine listino:</label>
        <p-dropdown id="headerImageSelect" [options]="availableHeaderImages" [(ngModel)]="selectedHeaderImage" 
          optionLabel="name" placeholder="Seleziona immagine listino" [style]="{ width: '100%' }" 
          styleClass="header-image-dropdown" appendTo="body" [autoZIndex]="true" [baseZIndex]="12000" 
          [panelStyle]="{ 'max-height': '40vh', 'overflow': 'auto' }">
          <ng-template let-headerImage pTemplate="item">
            <div class="header-image-option">
              <span class="header-image-name">{{ headerImage.name }}</span>
              <small class="header-image-description">{{ headerImage.description }}</small>
            </div>
          </ng-template>

          <ng-template let-selectedHeaderImage pTemplate="selectedItem">
            <div class="header-image-option" *ngIf="selectedHeaderImage">
              <span class="header-image-name">{{ selectedHeaderImage.name }}</span>
            </div>
          </ng-template>
        </p-dropdown>

        <small class="header-image-info" style="display:block; margin-top:1rem;">
          <i class="pi pi-info-circle" style="color: #1976d2;"></i>
          L'immagine selezionata apparirà come header nella prima pagina del listino PDF
        </small>
      </div>

      <!-- Selezione Lingua -->
      <div class="field">
        <label for="languageSelect">Lingua del listino:</label>
        <p-dropdown id="languageSelect" [options]="availableLanguages" [(ngModel)]="selectedLanguage" optionLabel="name"
          placeholder="Seleziona lingua" [style]="{ width: '100%' }" styleClass="language-dropdown" appendTo="body"
          [autoZIndex]="true" [baseZIndex]="12000" [panelStyle]="{ 'max-height': '40vh', 'overflow': 'auto' }">
          <ng-template let-language pTemplate="item">
            <div class="language-option">
              <span class="language-name">{{ language.name }}</span>
            </div>
          </ng-template>

          <ng-template let-selectedLanguage pTemplate="selectedItem">
            <div class="language-option" *ngIf="selectedLanguage">
              <span class="language-name">{{ selectedLanguage.name }}</span>
            </div>
          </ng-template>
        </p-dropdown>

        <small class="language-info" style="display:block; margin-top:1rem;">
          <i class="pi pi-info-circle" style="color: #1976d2;"></i>
          Il listino sarà tradotto automaticamente nella lingua selezionata
        </small>
      </div>
    </div>

    <ng-template pTemplate="footer">
      <p-button type="button" label="Annulla" styleClass="btn-dialog-no" (click)="cancelMarkup()"
        [disabled]="isTranslating"></p-button>
      <p-button type="button" label="Genera PDF" styleClass="btn-dialog-yes" (click)="generateWithMarkup()"
        [loading]="isTranslating" [disabled]="isTranslating"></p-button>
    </ng-template>
  </p-dialog>


  <!-- Dialog Modifica Prodotto -->
  <p-dialog [(visible)]="showEditProductDialog" [header]="editProductDialogTitle" [modal]="true" [closable]="false"
    [closeOnEscape]="true" [style]="{ width: '95vw', maxWidth: '1400px', height: '95vh' }"
    [breakpoints]="{ '960px': '95vw', '640px': '100vw' }" [draggable]="false" [resizable]="false"
    styleClass="modern-edit-product-dialog" (onHide)="onEditDialogHide()">

    <div class="modern-edit-container" *ngIf="editingProduct">
      <form #productForm="ngForm">
        <div class="edit-grid-layout">

          <!-- Left Column: Image and Basic Info -->
          <div class="left-column">
            <!-- Modern Images Section Card -->
            <div class="modern-card image-card">
              <div class="card-header">
                <h3 class="card-title">
                  <i class="pi pi-image"></i>
                  Immagini Prodotto (max 3)
                </h3>
              </div>
              <div class="card-content">
                <div class="modern-images-upload">
                  <!-- Existing Images Grid -->
                  <div class="images-grid" *ngIf="currentImagesToShow && currentImagesToShow.length > 0">
                    <div class="image-slot" *ngFor="let imageUrl of currentImagesToShow; let i = index">
                      <div class="image-wrapper">
                        <img [src]="imageUrl" [alt]="'Immagine prodotto ' + (i + 1)" class="product-preview-image" />
                        <div class="image-overlay">
                          <button type="button" class="image-edit-btn" (click)="triggerFileInput(i)"
                            title="Cambia immagine">
                            <i class="pi pi-pencil"></i>
                          </button>
                          <button type="button" class="image-delete-btn" (click)="removeProductImage(i)"
                            title="Rimuovi immagine">
                            <i class="pi pi-trash"></i>
                          </button>
                        </div>
                      </div>
                    </div>

                    <!-- Add New Image Slot (if less than 3) -->
                    <div class="image-slot add-slot"
                      *ngIf="(!currentImagesToShow || currentImagesToShow.length < 3) && !uploadingNewImages"
                      (click)="triggerFileInput()">
                      <div class="add-image-content">
                        <i class="pi pi-plus"></i>
                        <span>Aggiungi</span>
                      </div>
                    </div>
                  </div>

                  <!-- Upload Area (when no images or uploading) -->
                  <div class="upload-area"
                    [ngClass]="{ 'active': isUploadMode, 'has-images': currentImagesToShow && currentImagesToShow.length > 0 }"
                    *ngIf="shouldShowImagePlaceholder || uploadingNewImages || isUploadMode">
                    <div class="upload-content" *ngIf="!uploadingNewImages">
                      <div class="upload-icon">
                        <i class="pi pi-cloud-upload"></i>
                      </div>
                      <h4 class="upload-title">
                        {{ shouldShowImagePlaceholder ? 'Carica immagini' : 'Aggiungi immagini' }}
                      </h4>
                      <p class="upload-subtitle">Trascina i file qui o clicca per selezionare (max 3)</p>
                      <div class="upload-actions">
                        <p-button label="Scegli File" icon="pi pi-upload" styleClass="p-button-primary upload-btn"
                          (click)="triggerFileInput()">
                        </p-button>
                        <p-button *ngIf="isUploadMode && !shouldShowImagePlaceholder" label="Annulla" icon="pi pi-times"
                          styleClass="p-button-outlined cancel-btn" (click)="cancelImageUpload()">
                        </p-button>
                      </div>
                      <input #hiddenFileInput type="file" style="display: none" accept="image/*" multiple
                        (change)="onFileSelected($event)" />
                      <div class="upload-info">
                        <small><i class="pi pi-info-circle"></i> JPG, PNG fino a 5MB ciascuna</small>
                      </div>
                    </div>

                    <div class="upload-progress-area" *ngIf="uploadingNewImages">
                      <div class="progress-content">
                        <i class="pi pi-spin pi-spinner upload-spinner"></i>
                        <h4>Caricamento in corso...</h4>
                        <p-progressBar [value]="uploadProgress" styleClass="modern-progress"></p-progressBar>
                        <small>{{ uploadProgress }}% completato</small>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Basic Info Card -->
            <div class="modern-card info-card">
              <div class="card-header">
                <h3 class="card-title">
                  <i class="pi pi-info-circle"></i>
                  Informazioni Base
                </h3>
              </div>
              <div class="card-content">
                <div class="modern-field-group">
                  <p-floatLabel>
                    <input id="productName" name="name" pInputText type="text" [(ngModel)]="editingProduct.name"
                      required class="modern-input" />
                    <label for="productName">Nome Prodotto <span class="required-asterisk">*</span></label>
                  </p-floatLabel>
                  <small *ngIf="productForm.submitted && !editingProduct.name" class="field-error">
                    <i class="pi pi-exclamation-triangle"></i> Nome obbligatorio
                  </small>
                </div>

                <div class="modern-field-group">
                  <p-floatLabel>
                    <textarea id="productDescription" name="description" pInputTextarea rows="3" autoResize="true"
                      [(ngModel)]="editingProduct.description" class="modern-textarea">
                    </textarea>
                    <label for="productDescription">Descrizione</label>
                  </p-floatLabel>
                </div>
              </div>
            </div>
          </div>

          <!-- Right Column: Features and Variants -->
          <div class="right-column">
            <!-- Features Card -->
            <div class="modern-card features-card">
              <div class="card-header">
                <h3 class="card-title">
                  <i class="pi pi-cog"></i>
                  Caratteristiche Tecniche
                </h3>
              </div>
              <div class="card-content">
                <div class="features-grid">
                  <div class="modern-field-group">
                    <p-floatLabel>
                      <textarea id="productSeduta" name="seduta" pInputTextarea rows="2" autoResize="true"
                        [(ngModel)]="editingProduct.seduta" class="modern-textarea">
                      </textarea>
                      <label for="productSeduta">Seduta</label>
                    </p-floatLabel>
                  </div>

                  <div class="modern-field-group">
                    <p-floatLabel>
                      <textarea id="productSchienale" name="schienale" pInputTextarea rows="2" autoResize="true"
                        [(ngModel)]="editingProduct.schienale" class="modern-textarea">
                      </textarea>
                      <label for="productSchienale">Schienale</label>
                    </p-floatLabel>
                  </div>

                  <div class="modern-field-group">
                    <p-floatLabel>
                      <textarea id="productMeccanica" name="meccanica" pInputTextarea rows="2" autoResize="true"
                        [(ngModel)]="editingProduct.meccanica" class="modern-textarea">
                      </textarea>
                      <label for="productMeccanica">Meccanica</label>
                    </p-floatLabel>
                  </div>

                  <div class="modern-field-group">
                    <p-floatLabel>
                      <textarea id="productMaterasso" name="materasso" pInputTextarea rows="2" autoResize="true"
                        [(ngModel)]="editingProduct.materasso" class="modern-textarea">
                      </textarea>
                      <label for="productMaterasso">Materasso</label>
                    </p-floatLabel>
                  </div>
                </div>
              </div>
            </div>

            <!-- Variants Management Card -->
            <div class="modern-card variants-card">
              <div class="card-header">
                <h3 class="card-title">
                  <i class="pi pi-list"></i>
                  Gestione Varianti
                </h3>
              </div>
              <div class="card-content">
                <!-- Add/Edit Variant Form - Solo per modifica esistenti -->
                <div class="variant-form-section" *ngIf="editingVariantIndex >= 0">
                  <div class="variant-form-header">
                    <h4 class="editing-variant-title">
                      <i class="pi pi-pencil"></i>
                      Modifica Variante: {{ getSofaTypeLabel(newVariant.longName) }}
                    </h4>
                    <!-- <p-button icon="pi pi-times" label="Annulla Modifica" styleClass="p-button-outlined cancel-edit-btn"
                      (click)="cancelVariantEdit()">
                    </p-button> -->
                    <p-button icon="pi pi-times" label="Annulla" (onClick)="cancelVariantEdit()"
                      styleClass="p-button-text">
                    </p-button>
                  </div>

                  <div class="variant-form-grid">
                    <div class="form-col double-col">
                      <p-floatLabel class="pt-2">
                        <p-dropdown id="variantName" [options]="sofaTypeOptions" optionLabel="label" optionValue="value"
                          [(ngModel)]="newVariant.longName" name="variantName" class="modern-input w-100">
                        </p-dropdown>
                        <label for="variantName">Nome Variante</label>
                      </p-floatLabel>
                    </div>

                    <div class="form-col">
                      <p-floatLabel>
                        <p-inputNumber id="variantSeats" [(ngModel)]="newVariant.seatsCount" name="variantSeats"
                          [min]="1" [max]="20" styleClass="modern-input-number">
                        </p-inputNumber>
                        <label for="variantSeats">Posti</label>
                      </p-floatLabel>
                    </div>

                    <div class="form-col">
                      <p-floatLabel>
                        <p-inputNumber id="variantWidth" [(ngModel)]="newVariant.mattressWidth" name="variantWidth"
                          [min]="1" [max]="500" suffix=" cm" styleClass="modern-input-number">
                        </p-inputNumber>
                        <label for="variantWidth">Larghezza</label>
                      </p-floatLabel>
                    </div>
                    <div class="form-col">
                      <p-floatLabel>
                        <p-inputNumber id="variantDepth" [(ngModel)]="newVariant.depth" name="variantDepth"
                          [min]="1" [max]="500" suffix=" cm" styleClass="modern-input-number">
                        </p-inputNumber>
                        <label for="variantDepth">Profondità</label>
                      </p-floatLabel>
                    </div>
                    <div class="form-col">
                      <p-floatLabel>
                        <p-inputNumber id="variantHeight" [(ngModel)]="newVariant.height" name="variantHeight"
                          [min]="1" [max]="500" suffix=" cm" styleClass="modern-input-number">
                        </p-inputNumber>
                        <label for="variantHeight">Altezza</label>
                      </p-floatLabel>
                    </div>

                    <div class="form-col action-col">
                      <p-button label="Salva Modifiche" icon="pi pi-check" (onClick)="addVariantToProduct()"
                        [disabled]="!newVariant.longName" styleClass="modern-variant-btn">
                      </p-button>
                    </div>
                  </div>
                </div>

                <!-- Info message quando non si sta modificando -->
                <div class="variant-info-section" *ngIf="editingVariantIndex < 0">
                  <div class="info-message">
                    <i class="pi pi-info-circle"></i>
                    <span>Seleziona una variante dalla tabella sottostante per modificarla.</span>
                  </div>
                </div>

                <!-- Variants Table -->
                <div class="variants-table-section" *ngIf="editingVariants.length > 0">
                  <p-table [value]="editingVariants" styleClass="modern-variants-table"
                    [tableStyle]="{ 'min-width': '100%' }" [scrollable]="true">

                    <ng-template pTemplate="header">
                      <tr>
                        <th>Variante</th>
                        <th>Posti</th>
                        <th>Larghezza</th>
                        <th>Prezzo</th>
                        <th>Componenti</th>
                        <th>Azioni</th>
                      </tr>
                    </ng-template>

                    <ng-template pTemplate="body" let-variant let-i="rowIndex">
                      <tr>
                        <td>
                          <div class="variant-name-cell">
                            <span class="variant-title">{{ getSofaTypeLabel(variant.longName) }}</span>
                          </div>
                        </td>
                        <td>
                          <p-tag *ngIf="variant.seatsCount" [value]="variant.seatsCount" severity="info"
                            styleClass="compact-tag">
                          </p-tag>
                          <span *ngIf="!variant.seatsCount" class="text-muted">-</span>
                        </td>
                        <td>
                          <p-tag *ngIf="variant.mattressWidth" [value]="variant.mattressWidth + ' cm'"
                            severity="secondary" styleClass="compact-tag">
                          </p-tag>
                        </td>
                        <td>
                          <div class="price-cell">
                            <span class="price-value">€{{ variant.price.toFixed(2) }}</span>
                          </div>
                        </td>
                        <td>
                          <p-button icon="pi pi-plus"
                            styleClass="p-button-rounded p-button-text p-button-sm add-component-btn"
                            (click)="openAddComponentToVariant(variant)" pTooltip="Aggiungi componente"
                            tooltipPosition="top">
                          </p-button>
                        </td>
                        <td>
                          <div class="action-buttons">
                            <p-button icon="pi pi-pencil"
                              styleClass="p-button-rounded p-button-text p-button-sm edit-btn"
                              (click)="editVariantInProduct(i)" pTooltip="Modifica" tooltipPosition="top">
                            </p-button>
                            <p-button icon="pi pi-trash"
                              styleClass="p-button-rounded p-button-text p-button-sm p-button-danger delete-btn"
                              (click)="deleteVariantFromProduct(i)" pTooltip="Elimina" tooltipPosition="top">
                            </p-button>
                          </div>
                        </td>
                      </tr>

                      <!-- Components Row -->
                      <tr *ngIf="variant.components && variant.components.length > 0" class="components-row">
                        <td colspan="6">
                          <div class="components-section">
                            <div class="components-header">
                              <h5><i class="pi pi-th-large"></i> Componenti della variante</h5>
                            </div>
                            <div class="components-chips">
                              <div *ngFor="let group of getEditGroupedComponents(variant)"
                                class="component-chip-modern">
                                <div class="chip-content">
                                  <span class="chip-name">{{ formatComponentName(group.component) }}</span>
                                  <p-tag *ngIf="group.quantity > 1" [value]="'×' + group.quantity" severity="warning"
                                    styleClass="quantity-tag">
                                  </p-tag>
                                  <button pButton type="button" icon="pi pi-times"
                                    class="p-button-rounded p-button-text p-button-sm p-button-danger chip-remove-btn"
                                    (click)="removeGroupedComponent(variant, group)"
                                    [pTooltip]="group.quantity > 1 ? 'Rimuovi tutte le occorrenze' : 'Rimuovi componente'"
                                    tooltipPosition="top">
                                  </button>
                                </div>
                              </div>
                            </div>
                          </div>
                        </td>
                      </tr>
                    </ng-template>
                  </p-table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </form>
    </div>

    <ng-template pTemplate="footer">
      <div class="modern-dialog-footer">
        <p-button label="Annulla" icon="pi pi-times" styleClass="btn-dialog-no" (click)="cancelEditProduct()">
        </p-button>
        <p-button label="Salva Modifiche" icon="pi pi-check" styleClass="btn-dialog-yes"
          [disabled]="productForm?.invalid || saving" (click)="saveProductChanges()" [loading]="saving">
        </p-button>
      </div>
    </ng-template>
  </p-dialog>

  <!-- Dialog per aggiungere componenti alle varianti -->
  <p-dialog [(visible)]="showAddComponentDialog" header="Aggiungi Componente alla Variante" [modal]="true"
    [style]="{ width: '600px' }" [closable]="false">
    <div class="p-fluid">
      <div class="component-selection-grid">
        <div class="component-field">
          <label for="componentSelect">Componente <span class="required-field">*</span></label>
          <p-dropdown id="componentSelect" [options]="availableComponents" [(ngModel)]="selectedComponentForVariant"
            optionLabel="name" placeholder="Seleziona un componente" [showClear]="true" [filter]="true" filterBy="name"
            appendTo="body" [style]="{ width: '100%' }">
            <ng-template let-component pTemplate="item">
              {{ formatComponentName(component) }}
            </ng-template>
            <ng-template let-selectedComponent pTemplate="selectedItem">
              {{ formatComponentName(selectedComponent) }}
            </ng-template>
          </p-dropdown>
        </div>

        <div class="quantity-field">
          <label for="componentQuantity">Quantità <span class="required-field">*</span></label>
          <p-inputNumber id="componentQuantity" [(ngModel)]="componentQuantityForVariant" [min]="1" [max]="50"
            [style]="{ width: '100%' }">
          </p-inputNumber>
        </div>
      </div>

      <div class="selection-preview" *ngIf="selectedComponentForVariant">
        <div class="preview-content">
          <div class="preview-info">
            <strong>Componente selezionato:</strong>
            <span>{{ formatComponentName(selectedComponentForVariant) }}</span>
          </div>
          <div class="preview-price">
            <strong>Prezzo unitario:</strong>
            <span class="price-value">€{{ selectedComponentForVariant.price.toFixed(2) }}</span>
          </div>
          <div class="preview-total" *ngIf="componentQuantityForVariant && componentQuantityForVariant > 1">
            <strong>Totale (×{{ componentQuantityForVariant }}):</strong>
            <span class="total-value">€{{ (selectedComponentForVariant.price * componentQuantityForVariant).toFixed(2)
              }}</span>
          </div>
        </div>
      </div>
    </div>

    <ng-template pTemplate="footer">
      <button pButton type="button" icon="pi pi-times" label="Annulla" (click)="cancelAddComponent()"
        class="btn-dialog-no"></button>
      <button pButton type="button" icon="pi pi-check" label="Aggiungi" (click)="addComponentToVariant()"
        [disabled]="!selectedComponentForVariant || !componentQuantityForVariant" class="btn-dialog-yes"></button>
    </ng-template>
  </p-dialog>

  <!-- Dialog per configurare componenti di nuova variante -->
  <p-dialog [(visible)]="showVariantComponentsDialog" [header]="variantComponentsDialogTitle" [modal]="true"
    [style]="{ width: '90vw', maxWidth: '800px', height: '85vh' }" [closable]="false" [draggable]="false"
    [resizable]="false" styleClass="variant-components-dialog">
    <div class="variant-components-container">
      <div class="p-fluid">
        <!-- Fusto -->
        <div class="p-field p-grid">
          <label class="p-col-12 p-md-3">Fusto <span class="required-field">*</span></label>
          <div class="p-col-12 p-md-9">
            <p-dropdown [options]="getComponentsByType('fusto')" [(ngModel)]="selectedFusto" optionLabel="name"
              placeholder="Seleziona fusto" [showClear]="true" [disabled]="getComponentsByType('fusto').length === 0"
              (onChange)="onVariantComponentSelected('fusto', $event.value)" [style]="{width: '100%'}">
              <ng-template let-item pTemplate="item">
                {{ formatComponentName(item) }}
              </ng-template>
              <ng-template let-selectedItem pTemplate="selectedItem">
                {{ formatComponentName(selectedItem) }}
              </ng-template>
            </p-dropdown>
            <small *ngIf="getComponentsByType('fusto').length === 0" class="p-error">
              Nessun componente di tipo fusto disponibile
            </small>
          </div>
        </div>

        <!-- Gomma -->
        <div class="p-field p-grid">
          <label class="p-col-12 p-md-3">Gomma <span class="required-field">*</span></label>
          <div class="p-col-12 p-md-9">
            <p-dropdown [options]="getComponentsByType('gomma')" [(ngModel)]="selectedGomma" optionLabel="name"
              placeholder="Seleziona gomma" [showClear]="true" [disabled]="getComponentsByType('gomma').length === 0"
              (onChange)="onVariantComponentSelected('gomma', $event.value)" [style]="{width: '100%'}">
              <ng-template let-item pTemplate="item">
                {{ formatComponentName(item) }}
              </ng-template>
              <ng-template let-selectedItem pTemplate="selectedItem">
                {{ formatComponentName(selectedItem) }}
              </ng-template>
            </p-dropdown>
            <small *ngIf="getComponentsByType('gomma').length === 0" class="p-error">
              Nessun componente di tipo gomma disponibile
            </small>
          </div>
        </div>

        <!-- Piedini -->
        <div class="p-field p-grid">
          <label class="p-col-12 p-md-3">Piedini <span class="required-field">*</span></label>
          <div class="p-col-12 p-md-6">
            <p-dropdown [options]="getComponentsByType('piedini')" [(ngModel)]="selectedPiedini" optionLabel="name"
              placeholder="Seleziona piedini" [showClear]="true"
              [disabled]="getComponentsByType('piedini').length === 0"
              (onChange)="onVariantComponentSelected('piedini', $event.value)" [style]="{width: '100%'}">
              <ng-template let-item pTemplate="item">
                {{ formatComponentName(item) }}
              </ng-template>
              <ng-template let-selectedItem pTemplate="selectedItem">
                {{ formatComponentName(selectedItem) }}
              </ng-template>
            </p-dropdown>
            <small *ngIf="getComponentsByType('piedini').length === 0" class="p-error">
              Nessun componente di tipo piedini disponibile
            </small>
          </div>
          <div class="p-col-12 p-md-3">
            <p-dropdown [options]="piediniQuantityOptions" [(ngModel)]="piediniQty" placeholder="Quantità"
              [disabled]="!selectedPiedini" [style]="{width: '100%'}">
            </p-dropdown>
          </div>
        </div>

        <!-- Meccanismo -->
        <div class="p-field p-grid">
          <label class="p-col-12 p-md-3">Meccanismo <span class="required-field">*</span></label>
          <div class="p-col-12 p-md-9">
            <p-dropdown [options]="getComponentsByType('meccanismo')" [(ngModel)]="selectedMeccanismo"
              optionLabel="name" placeholder="Seleziona meccanismo" [showClear]="true"
              [disabled]="getComponentsByType('meccanismo').length === 0"
              (onChange)="onVariantComponentSelected('meccanismo', $event.value)" [style]="{width: '100%'}">
              <ng-template let-item pTemplate="item">
                {{ formatComponentName(item) }}
              </ng-template>
              <ng-template let-selectedItem pTemplate="selectedItem">
                {{ formatComponentName(selectedItem) }}
              </ng-template>
            </p-dropdown>
            <small *ngIf="getComponentsByType('meccanismo').length === 0" class="p-error">
              Nessun componente di tipo meccanismo disponibile
            </small>
          </div>
        </div>

        <!-- Materasso -->
        <div class="p-field p-grid">
          <label class="p-col-12 p-md-3">Materasso <span class="required-field">*</span></label>
          <div class="p-col-12 p-md-9">
            <p-dropdown [options]="getComponentsByType('materasso')" [(ngModel)]="selectedMaterasso" optionLabel="name"
              placeholder="Seleziona materasso" [showClear]="true"
              [disabled]="getComponentsByType('materasso').length === 0"
              (onChange)="onVariantComponentSelected('materasso', $event.value)" [style]="{width: '100%'}">
              <ng-template let-item pTemplate="item">
                {{ formatComponentName(item) }}
              </ng-template>
              <ng-template let-selectedItem pTemplate="selectedItem">
                {{ formatComponentName(selectedItem) }}
              </ng-template>
            </p-dropdown>
            <small *ngIf="getComponentsByType('materasso').length === 0" class="p-error">
              Nessun componente di tipo materasso disponibile
            </small>
          </div>
        </div>

        <!-- Ferramenta -->
        <div class="p-field p-grid">
          <label class="p-col-12 p-md-3">Ferramenta <span class="required-field">*</span></label>
          <div class="p-col-12 p-md-9">
            <p-multiSelect [options]="getComponentsByType('ferramenta')" [(ngModel)]="ferramentaList" optionLabel="name"
              placeholder="Seleziona ferramenta" [disabled]="getComponentsByType('ferramenta').length === 0"
              [style]="{width: '100%'}">
              <ng-template let-item pTemplate="item">
                {{ formatComponentName(item) }}
              </ng-template>
            </p-multiSelect>
            <small *ngIf="getComponentsByType('ferramenta').length === 0" class="p-error">
              Nessun componente di tipo ferramenta disponibile
            </small>
          </div>
        </div>

        <!-- Imballo -->
        <div class="p-field p-grid">
          <label class="p-col-12 p-md-3">Imballo <span class="required-field">*</span></label>
          <div class="p-col-12 p-md-9">
            <p-dropdown [options]="getComponentsByType('imballo')" [(ngModel)]="selectedImballo" optionLabel="name"
              placeholder="Seleziona imballo" [showClear]="true"
              [disabled]="getComponentsByType('imballo').length === 0"
              (onChange)="onVariantComponentSelected('imballo', $event.value)" [style]="{width: '100%'}">
              <ng-template let-item pTemplate="item">
                {{ formatComponentName(item) }}
              </ng-template>
              <ng-template let-selectedItem pTemplate="selectedItem">
                {{ formatComponentName(selectedItem) }}
              </ng-template>
            </p-dropdown>
            <small *ngIf="getComponentsByType('imballo').length === 0" class="p-error">
              Nessun componente di tipo imballo disponibile
            </small>
          </div>
        </div>

        <!-- Scatola -->
        <div class="p-field p-grid">
          <label class="p-col-12 p-md-3">Scatola</label>
          <div class="p-col-12 p-md-9">
            <p-dropdown [options]="getComponentsByType('scatola')" [(ngModel)]="selectedScatola" optionLabel="name"
              placeholder="Seleziona scatola" [showClear]="true"
              [disabled]="getComponentsByType('scatola').length === 0"
              (onChange)="onVariantComponentSelected('scatola', $event.value)" [style]="{width: '100%'}">
              <ng-template let-item pTemplate="item">
                {{ formatComponentName(item) }}
              </ng-template>
              <ng-template let-selectedItem pTemplate="selectedItem">
                {{ formatComponentName(selectedItem) }}
              </ng-template>
            </p-dropdown>
            <small *ngIf="getComponentsByType('scatola').length === 0" class="p-error">
              Nessun componente di tipo scatola disponibile
            </small>
          </div>
        </div>

        <!-- Varie -->
        <div class="p-field p-grid">
          <label class="p-col-12 p-md-3">Varie</label>
          <div class="p-col-12 p-md-9">
            <p-multiSelect [options]="getComponentsByType('varie')" [(ngModel)]="varieList" optionLabel="name"
              placeholder="Seleziona eventuali extra" [disabled]="getComponentsByType('varie').length === 0"
              [style]="{width: '100%'}">
              <ng-template let-item pTemplate="item">
                {{ formatComponentName(item) }}
              </ng-template>
            </p-multiSelect>
            <small *ngIf="getComponentsByType('varie').length === 0" class="p-error">
              Nessun componente di tipo varie disponibile
            </small>
          </div>
        </div>

        <!-- Rivestimenti per nuova variante -->
        <div class="p-field p-grid">
          <label class="p-col-12 p-md-3">Rivestimenti <span class="required-field">*</span></label>
          <div class="p-col-12 p-md-9">
            <p-multiSelect [options]="rivestimentiList" [(ngModel)]="selectedRivestimentiForVariant" optionLabel="name"
              placeholder="Seleziona rivestimenti" [disabled]="rivestimentiList.length === 0" [style]="{width: '100%'}">
            </p-multiSelect>
            <small *ngIf="rivestimentiList.length === 0" class="p-error">
              Nessun rivestimento disponibile
            </small>
          </div>
        </div>

      </div>
    </div>

    <ng-template pTemplate="footer">
      <div class="dialog-footer">
        <button pButton type="button" label="Annulla" class="btn-dialog-no"
          (click)="cancelVariantComponentsDialog()"></button>
        <button pButton type="button" label="Aggiungi Variante" class="btn-dialog-yes"
          (click)="applyComponentsToNewVariant()"></button>
      </div>
    </ng-template>
  </p-dialog>

  <p-toast></p-toast>
  <p-confirmDialog [closable]="false" appendTo="body" [baseZIndex]="12000"></p-confirmDialog>

  <p-dialog header="Conferma Eliminazione" [(visible)]="displayConfirmDelete" [modal]="true" [closable]="false"
    [style]="{ width: '40%' }">
    <p>Sei sicuro di voler eliminare il prodotto "{{ productToDelete?.name }}"?</p>

    <ng-template pTemplate="footer">
      <button pButton type="button" label="No" icon="pi pi-times" class="btn-dialog-no" (click)="rejectDelete()">
      </button>

      <button pButton type="button" label="Sì" icon="pi pi-check" class="btn-dialog-yes" (click)="confirmDelete()"
        autofocus>
      </button>
    </ng-template>
  </p-dialog>
</div>
