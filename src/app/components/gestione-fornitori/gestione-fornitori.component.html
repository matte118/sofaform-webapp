<div class="gestione-fornitori-container">
  <p-toast></p-toast>

  <div class="page-header">
    <h1>Gestione Fornitori</h1>
    <p>Gestisci i fornitori per i componenti dei prodotti</p>
  </div>

  <div class="supplier-form-card" [ngClass]="{ 'editing-mode': isEditing }">
    <h2 style="padding-bottom: 20px;">{{ formTitle }}</h2>
    <form class="supplier-form" #supplierForm="ngForm">
      <div class="form-row">
        <div class="form-group">
          <p-floatLabel>
            <input pInputText id="supplierName" name="name" type="text" [(ngModel)]="newSupplier.name"
              [class.ng-invalid]="shouldShowFieldError(newSupplier.name)" />
            <label for="supplierName">Nome <span class="required-field">*</span></label>
          </p-floatLabel>
          <small *ngIf="shouldShowFieldError(newSupplier.name)" class="p-error">
            Il nome del fornitore è obbligatorio
          </small>
        </div>

        <div class="form-group">
          <p-floatLabel>
            <input pInputText id="supplierContact" name="contact" type="text"
            [(ngModel)]="newSupplier.contact" />
            <label for="supplierContact">Contatto</label>
          </p-floatLabel>
        </div>
      </div>

      <div class="form-actions">
        <p-button [label]="submitButtonLabel" (onClick)="addSupplier()" styleClass="primary-button"></p-button>
        <p-button *ngIf="isEditing" label="Annulla" (onClick)="resetForm()" styleClass="secondary-button"></p-button>
      </div>
    </form>
  </div>

  <div class="supplier-table-section">
    <h3>Lista Fornitori</h3>

    <div *ngIf="loading" class="loading-message">
      <i class="pi pi-spin pi-spinner" style="font-size: 2rem"></i>
      <p>Caricamento fornitori...</p>
    </div>

    <p-table *ngIf="dataLoaded && !loading" #supplierTable [value]="suppliers"
      styleClass="p-datatable-sm suppliers-table" [paginator]="true" [rows]="10"
      [globalFilterFields]="['name', 'contact']" [rowHover]="true" #dt>
      <ng-template pTemplate="caption">
        <div class="table-header">
          <h4>Fornitori ({{ suppliers.length }})</h4>
          <div class="search-container">
            <input pInputText type="text" placeholder="Cerca fornitore..." (input)="onGlobalFilter($event, dt)" />
          </div>
        </div>
      </ng-template>

      <ng-template pTemplate="header">
        <tr>
          <th>Nome</th>
          <th>Contatto</th>
          <th>Azioni</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-supplier let-i="rowIndex">
        <tr>
          <td>{{ supplier.name }}</td>
          <td>{{ supplier.contact ? supplier.contact : 'ND' }}</td>
          <td class="actions-cell">
            <div class="action-buttons">
              <p-button type="button" icon="pi pi-pencil"
                styleClass="p-button-rounded p-button-text p-button transparent-icon-btn"
                (click)="editSupplier(supplier, i)" pTooltip="Modifica"></p-button>
              <p-button type="button" icon="pi pi-trash"
                styleClass="p-button-rounded p-button-text p-button transparent-red-icon"
                (click)="deleteSupplier(supplier)" pTooltip="Elimina"></p-button>
            </div>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="3" class="empty-message">Nessun fornitore trovato</td>
        </tr>
      </ng-template>
    </p-table>
  </div>

  <!-- Dialog di conferma eliminazione -->
  <p-dialog header="Conferma Eliminazione" [(visible)]="displayConfirmDelete" [modal]="true" [closable]="false"
    [style]="{ width: '600px', maxWidth: '95vw' }">
    <!-- 1) Se stiamo caricando, mostro spinner -->
    <ng-container *ngIf="loadingDependencies; else loadedList">
      <div class="loading-list">
        <i class="pi pi-spin pi-spinner"></i>
        <span>Caricamento componenti…</span>
      </div>
    </ng-container>

    <!-- 2) Quando finito, se ci sono dipendenze -->
    <ng-template #loadedList>
      <ng-container *ngIf="supplierDependentComponents.length > 0; else noDeps">
        <div class="supplier-usage-warning">
          <div class="warning-text">
            Questo fornitore fornisce i seguenti componenti:
          </div>
          <ul class="component-list">
            <li *ngFor="let name of supplierDependentComponents" class="component-item">
              {{ name }}
            </li>
          </ul>
          <div class="removal-warning">
            <i class="pi pi-info-circle info-icon" style="color: #007bff;"></i>
            <strong>Se procedi, tutti questi componenti verranno eliminati.</strong>
          </div>
        </div>
      </ng-container>
      <ng-template #noDeps>
        <p>
          Sei sicuro di voler eliminare il fornitore
          <strong>{{ supplierToDelete?.name }}</strong>?
        </p>
      </ng-template>
    </ng-template>

    <ng-template pTemplate="footer">
      <button pButton type="button" label="No" icon="pi pi-times" class="btn-dialog-no"
        (click)="rejectDelete()"></button>
      <button pButton type="button" label="Sì" icon="pi pi-check" class="btn-dialog-yes" (click)="confirmDelete()"
        [disabled]="loadingDependencies" autofocus></button>
    </ng-template>
  </p-dialog>

</div>