<div class="add-product-container">
  <p-toast></p-toast>

  <p-card header="Aggiungi Nuovo Prodotto" class="p-mb-4">
    <p-steps
      [model]="steps"
      [(activeIndex)]="currentStep"
      [readonly]="true"
      class="p-mb-4"
    ></p-steps>

    <form class="p-fluid p-formgrid p-grid">
      <!-- Step 1: Informazioni Prodotto -->
      <ng-container *ngIf="currentStep === 0">
        <div class="p-field p-col-12 p-md-6">
          <label for="productName">Nome Prodotto</label>
          <input
            id="productName"
            pInputText
            [(ngModel)]="newSofaProduct.name"
            name="nome"
            required
            placeholder="Inserisci il nome del prodotto"
          />
          <small *ngIf="!newSofaProduct.name?.trim()" class="p-error">
            Campo obbligatorio
          </small>
        </div>

        <div class="p-field p-col-12">
          <label for="productDescription">Descrizione</label>
          <textarea
            id="productDescription"
            pInputTextarea
            [(ngModel)]="newSofaProduct.description"
            name="descrizione"
            rows="5"
            placeholder="Inserisci una descrizione del prodotto"
          ></textarea>
        </div>
      </ng-container>

      <!-- Step 2: Varianti -->
      <ng-container *ngIf="currentStep === 1">
        <div class="p-field p-col-12">
          <h3>Varianti del Prodotto</h3>

          <div class="p-grid p-nogutter p-align-end">
            <div class="p-field p-col-12 p-md-4">
              <p-floatLabel>
                <input
                  id="variantName"
                  pInputText
                  [(ngModel)]="newVariant.longName"
                  name="nomeVariante"
                  required
                />
                <label>Nome Variante</label>
              </p-floatLabel>
            </div>

            <div class="p-field p-col-12 p-md-2">
              <p-floatLabel>
                <p-inputNumber
                  id="seatsCount"
                  [(ngModel)]="newVariant.seatsCount"
                  name="postiSeduta"
                ></p-inputNumber>
                <label>Numero Posti</label>
              </p-floatLabel>
            </div>

            <div class="p-field p-col-12 p-md-2">
              <p-floatLabel>
                <p-inputNumber
                  id="mattressWidth"
                  [(ngModel)]="newVariant.mattressWidth"
                  name="larghezzaMaterasso"
                ></p-inputNumber>
                <label>Larghezza (cm)</label>
              </p-floatLabel>
            </div>

            <div class="p-field p-col-12 p-md-1">
              <p-button
                [icon]="editingVariantIndex >= 0 ? 'pi pi-check' : 'pi pi-plus'"
                [label]="editingVariantIndex >= 0 ? 'Aggiorna' : 'Aggiungi'"
                (onClick)="addVariant()"
                [disabled]="!newVariant.longName.trim()"
              >
              </p-button>
            </div>
          </div>

          <p-table
            [value]="variants"
            *ngIf="variants.length"
            [paginator]="true"
            [rows]="5"
            class="p-mt-3"
          >
            <ng-template pTemplate="header">
              <tr>
                <th>Nome</th>
                <th>Posti</th>
                <th>Larghezza</th>
                <th>Azioni</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-variant let-i="rowIndex">
              <tr>
                <td>{{ variant.longName }}</td>
                <td>{{ variant.seatsCount || "N/A" }}</td>
                <td>
                  {{
                    variant.mattressWidth
                      ? variant.mattressWidth + " cm"
                      : "N/A"
                  }}
                </td>
                <td>
                  <p-button
                    icon="pi pi-pencil"
                    (onClick)="editVariant(i)"
                    styleClass="p-button-text p-button-sm"
                  ></p-button>
                  <p-button
                    icon="pi pi-trash"
                    (onClick)="deleteVariant(i)"
                    styleClass="p-button-danger p-button-text p-button-sm"
                  ></p-button>
                </td>
              </tr>
            </ng-template>
          </p-table>
        </div>
      </ng-container>

      <!-- Step 3: Componenti -->
      <ng-container *ngIf="currentStep === 2">
        <div class="p-field p-col-12">
          <h3>Seleziona Variante</h3>
          <p-dropdown
            [options]="variants"
            [(ngModel)]="selectedVariant"
            optionLabel="longName"
            name="selectedVariant"
            placeholder="Seleziona una variante"
            [showClear]="false"
            [required]="true"
          >
          </p-dropdown>

          <div *ngIf="selectedVariant" class="p-mt-4">
            <h3>Componenti per: {{ selectedVariant.longName }}</h3>

            <!-- Existing components selection -->
            <div class="existing-components p-mb-4">
              <h4>Seleziona Componenti Esistenti</h4>
              <div class="p-grid p-nogutter p-align-end">
                <div class="p-field p-col-12 p-md-8">
                  <p-dropdown
                    [options]="availableComponents"
                    [(ngModel)]="selectedComponent"
                    optionLabel="name"
                    [filter]="true"
                    filterBy="name"
                    placeholder="Seleziona un componente esistente"
                    [showClear]="true"
                    name="existingComponent"
                  >
                  </p-dropdown>
                </div>
                <div class="p-field p-col-12 p-md-4">
                  <p-button
                    label="Aggiungi Componente"
                    (onClick)="addComponentToVariant(selectedComponent!)"
                    [disabled]="!selectedComponent"
                  >
                  </p-button>
                </div>
              </div>
            </div>

            <p-divider></p-divider>

            <!-- Create new component -->
            <div class="p-mb-4">
              <h4>Crea Nuovo Componente</h4>
              <div class="p-grid p-nogutter p-align-end">
                <div class="p-field p-col-12 p-md-4">
                  <p-floatLabel>
                    <input
                      id="componentName"
                      pInputText
                      [(ngModel)]="newComponent.name"
                      name="compName"
                      required
                    />
                    <label>Nome Componente</label>
                  </p-floatLabel>
                </div>

                <div class="p-field p-col-12 p-md-3">
                  <p-floatLabel>
                    <p-inputNumber
                      id="componentPrice"
                      [(ngModel)]="newComponent.price"
                      name="compPrice"
                      mode="currency"
                      currency="EUR"
                      [minFractionDigits]="2"
                    ></p-inputNumber>
                    <label>Prezzo</label>
                  </p-floatLabel>
                </div>

                <div class="p-field p-col-12 p-md-4">
                  <div class="p-d-flex p-ai-center">
                    <p-dropdown
                      [options]="availableSuppliers"
                      [(ngModel)]="selectedSuppliers"
                      optionLabel="name"
                      [filter]="true"
                      filterBy="name"
                      name="suppliers"
                      placeholder="Seleziona fornitori"
                      class="p-mr-2 p-w-100"
                    >
                    </p-dropdown>
                    <p-button
                      icon="pi pi-plus"
                      styleClass="p-button-rounded p-button-text"
                      pTooltip="Aggiungi nuovo fornitore"
                      (onClick)="openAddSupplierDialog()"
                    >
                    </p-button>
                  </div>
                </div>

                <div class="p-field p-col-12 p-md-1">
                  <p-button
                    label="Crea"
                    (onClick)="createComponent()"
                    [disabled]="!newComponent.name.trim()"
                  >
                  </p-button>
                </div>
              </div>
            </div>

            <!-- Components table -->
            <p-table
              [value]="selectedVariant.components"
              *ngIf="selectedVariant.components.length"
              [paginator]="true"
              [rows]="5"
              class="p-mt-3"
            >
              <ng-template pTemplate="header">
                <tr>
                  <th>Nome</th>
                  <th>Prezzo</th>
                  <th>Fornitori</th>
                  <th>Azioni</th>
                </tr>
              </ng-template>
              <ng-template pTemplate="body" let-comp let-i="rowIndex">
                <tr>
                  <td>{{ comp.name }}</td>
                  <td>{{ comp.price | currency : "EUR" }}</td>
                  <td>
                    <span
                      *ngFor="let supplier of comp.suppliers; let last = last"
                    >
                      {{ supplier.name }}{{ !last ? ", " : "" }}
                    </span>
                  </td>
                  <td>
                    <p-button
                      icon="pi pi-trash"
                      (onClick)="
                        removeComponentFromVariant(
                          variants.indexOf(selectedVariant!),
                          i
                        )
                      "
                      styleClass="p-button-danger p-button-text p-button-sm"
                    >
                    </p-button>
                  </td>
                </tr>
              </ng-template>
            </p-table>
          </div>
        </div>
      </ng-container>
      <!-- Save product button -->
      <div class="p-field p-col-12" *ngIf="currentStep === 2">
        <p-divider></p-divider>

        <div class="p-text-center p-mt-4">
          <p-button
            label="Salva Prodotto"
            icon="pi pi-save"
            (onClick)="saveProduct()"
          ></p-button>
        </div>
      </div>

      <!-- Navigation buttons -->
      <div class="p-col-12">
        <p-divider class="p-mt-4"></p-divider>
        <div class="p-d-flex p-jc-between p-mt-3">
          <p-button
            *ngIf="currentStep > 0"
            label="Indietro"
            (onClick)="prevStep()"
            styleClass="p-button-outlined"
          >
          </p-button>

          <p-button
            *ngIf="currentStep < steps.length - 1"
            label="Avanti"
            (onClick)="nextStep()"
            styleClass="p-button-primary"
          >
          </p-button>
        </div>
      </div>
    </form>
  </p-card>

  <!-- Add Supplier Dialog -->
  <p-dialog
    [(visible)]="showAddSupplierDialog"
    header="Aggiungi Nuovo Fornitore"
    [modal]="true"
    [style]="{ width: '450px' }"
  >
    <div class="p-fluid">
      <div class="p-field">
        <label for="supplierName">Nome Fornitore</label>
        <input
          id="supplierName"
          type="text"
          pInputText
          [(ngModel)]="newSupplier.name"
          required
        />
        <small *ngIf="!newSupplier.name?.trim()" class="p-error"
          >Campo obbligatorio</small
        >
      </div>

      <div class="p-field">
        <label for="supplierContact">Contatto</label>
        <input
          id="supplierContact"
          type="text"
          pInputText
          [(ngModel)]="newSupplier.contact"
        />
        <small>Email o telefono del fornitore</small>
      </div>
    </div>

    <ng-template pTemplate="footer">
      <p-button
        icon="pi pi-times"
        label="Annulla"
        (onClick)="cancelAddSupplier()"
        styleClass="p-button-text"
      >
      </p-button>
      <p-button
        icon="pi pi-check"
        label="Salva"
        (onClick)="saveSupplier()"
        [disabled]="!newSupplier.name.trim()"
      >
      </p-button>
    </ng-template>
  </p-dialog>

  <p-confirmDialog
    header="Conferma"
    icon="pi pi-exclamation-triangle"
  ></p-confirmDialog>
</div>
