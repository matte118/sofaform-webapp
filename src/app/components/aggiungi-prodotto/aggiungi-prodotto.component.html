<div class="add-product-container">
  <p-toast></p-toast>
  <div *ngIf="isSavingProduct" class="saving-overlay">
    <div class="saving-content">
      <p-progressSpinner [style]="{ width: '80px', height: '80px' }" strokeWidth="4" fill="transparent"
        animationDuration="1.5s"></p-progressSpinner>
      <h3>Salvataggio in corso...</h3>
      <small>Non chiudere la pagina</small>
    </div>
  </div>

  <div [class.disabled-content]="isSavingProduct">
    <p-card header="Aggiungi Nuovo Prodotto" class="p-mb-4">
      <p-steps [model]="steps" [(activeIndex)]="currentStep" [readonly]="true" class="p-mb-4"></p-steps>

      <br />
      <br />

      <form class="p-fluid p-formgrid p-grid">
        <ng-container *ngIf="currentStep === 0">
          <div class="p-field p-col-12 p-md-6" style="padding-top: 10px;">
            <p-floatLabel variant="on">
              <input id="productName" pInputText [(ngModel)]="newSofaProduct.name" name="nome" required
                [class.ng-invalid]="shouldShowProductFieldError(newSofaProduct.name)" />
              <label for="on_label">Nome Prodotto</label>
            </p-floatLabel>
            <small *ngIf="shouldShowProductFieldError(newSofaProduct.name)" class="p-error">
              Campo obbligatorio
            </small>
          </div>

          <div class="p-field p-col-12 p-md-6">
            <div class="image-upload-section">
              <p-fileUpload *ngIf="!imagePreview && !isUploading" mode="basic" name="productImage" accept="image/*"
                [maxFileSize]="5000000" (onSelect)="onFileSelect($event)" chooseLabel="Seleziona Immagine"
                [auto]="false" styleClass="transparent-upload-btn">
              </p-fileUpload>


              <!-- Preview dell'immagine -->
              <div *ngIf="imagePreview && !isUploading" class="image-preview-container">
                <img [src]="imagePreview" alt="Anteprima" class="image-preview" />
                <div class="image-actions">
                  <p-button icon="pi pi-times" (onClick)="removeImage()" styleClass="p-button-danger p-button-sm"
                    pTooltip="Rimuovi immagine"></p-button>
                </div>
              </div>

              <!-- Upload in corso -->
              <div *ngIf="isUploading" class="upload-progress-container">
                <div class="upload-spinner-section">
                  <p-progressSpinner [style]="{ width: '50px', height: '50px' }" strokeWidth="4" fill="transparent"
                    animationDuration="1s"></p-progressSpinner>
                  <span class="upload-text">Caricamento immagine...</span>
                </div>
              </div>
            </div>
          </div>

          <div class="p-field p-col-12">
            <p-floatLabel>
              <textarea id="productDescription" pInputTextarea [(ngModel)]="newSofaProduct.description"
                name="descrizione" rows="5"></textarea>
              <label>Descrizione</label>
            </p-floatLabel>
          </div>

          <!-- Pulsanti per campi opzionali in due colonne -->
          <div class="p-field p-col-12">
            <div class="optional-fields-grid">
              <!-- Seduta -->
              <div class="optional-field-cell">
                <p-button [label]="'Seduta'" [icon]="newSofaProduct.seduta ? 'pi pi-trash' : ''" (onClick)="
                    newSofaProduct.seduta
                      ? (newSofaProduct.seduta = '')
                      : (showSedutaDialog = true)
                  " [styleClass]="
                    newSofaProduct.seduta
                      ? 'gradient-filled optional-btn'
                      : 'p-button-outlined optional-btn'
                  " pTooltip="{{
                    newSofaProduct.seduta
                      ? 'Rimuovi contenuto'
                      : 'Aggiungi seduta'
                  }}"></p-button>
              </div>
              <!-- Schienale -->
              <div class="optional-field-cell">
                <p-button [label]="'Schienale'" [icon]="newSofaProduct.schienale ? 'pi pi-trash' : ''" (onClick)="
                    newSofaProduct.schienale
                      ? (newSofaProduct.schienale = '')
                      : (showSchienaleDialog = true)
                  " [styleClass]="
                    newSofaProduct.schienale
                      ? 'gradient-filled optional-btn'
                      : 'p-button-outlined optional-btn'
                  " pTooltip="{{
                    newSofaProduct.schienale
                      ? 'Rimuovi contenuto'
                      : 'Aggiungi schienale'
                  }}"></p-button>
              </div>
              <!-- Meccanica -->
              <div class="optional-field-cell">
                <p-button [label]="'Meccanica'" [icon]="newSofaProduct.meccanica ? 'pi pi-trash' : ''" (onClick)="
                    newSofaProduct.meccanica
                      ? (newSofaProduct.meccanica = '')
                      : (showMeccanicaDialog = true)
                  " [styleClass]="
                    newSofaProduct.meccanica
                      ? 'gradient-filled optional-btn'
                      : 'p-button-outlined optional-btn'
                  " pTooltip="{{
                    newSofaProduct.meccanica
                      ? 'Rimuovi contenuto'
                      : 'Aggiungi meccanica'
                  }}"></p-button>
              </div>
              <!-- Materasso -->
              <div class="optional-field-cell">
                <p-button [label]="'Materasso'" [icon]="newSofaProduct.materasso ? 'pi pi-trash' : ''" (onClick)="
                    newSofaProduct.materasso
                      ? (newSofaProduct.materasso = '')
                      : (showMaterassoDialog = true)
                  " [styleClass]="
                    newSofaProduct.materasso
                      ? 'gradient-filled optional-btn'
                      : 'p-button-outlined optional-btn'
                  " pTooltip="{{
                    newSofaProduct.materasso
                      ? 'Rimuovi contenuto'
                      : 'Aggiungi materasso'
                  }}"></p-button>
              </div>
            </div>
          </div>
        </ng-container>

        <!-- Step 2: Varianti -->
        <ng-container *ngIf="currentStep === 1">
          <div class="p-field p-col-12">
            <h3>Varianti del Prodotto</h3>

<div style="padding-bottom: 15px;">
  <p-selectButton
  [options]="pricingOptions"
  [(ngModel)]="selectedPricingMode"
  optionLabel="label"
  optionValue="value"
  (onChange)="onPricingModeChange()"
  name="pricingMode"
  styleClass="segmented-control" >
  
</p-selectButton>
</div>





            <div class="p-grid p-nogutter p-align-end" style="padding-top: 15px;">
              <div class="p-field p-col-12 p-md-2">
                <p-floatLabel>
                  <input id="variantName" pInputText [(ngModel)]="newVariant.longName" name="nomeVariante" required
                    [class.ng-invalid]="shouldShowVariantFieldError(newVariant.longName)" />
                  <label>Nome Variante</label>
                </p-floatLabel>
                <small *ngIf="shouldShowVariantFieldError(newVariant.longName)" class="p-error">
                  Il nome della variante è obbligatorio
                </small>
              </div>

              <div class="p-field p-col-12 p-md-2" style="padding-top: 15px;">
                <p-floatLabel>
                  <p-inputNumber id="seatsCount" [(ngModel)]="newVariant.seatsCount" name="postiSeduta"></p-inputNumber>
                  <label>Numero Posti</label>
                </p-floatLabel>
              </div>

              <div class="p-field p-col-12 p-md-2" style="padding-top: 15px;">
                <p-floatLabel>
                  <p-inputNumber id="mattressWidth" [(ngModel)]="newVariant.mattressWidth"
                    name="larghezzaMaterasso"></p-inputNumber>
                  <label>Larghezza (cm)</label>
                </p-floatLabel>
              </div>

              <!-- Custom Price Field - only show if custom mode selected -->
              <div class="p-field p-col-12 p-md-2" style="padding-top: 15px;" *ngIf="isCustomPricingMode()">
                <p-floatLabel>
                  <p-inputNumber id="customPrice" [(ngModel)]="customVariantPrice" name="customPrice" 
                    mode="currency" currency="EUR" locale="it-IT" [min]="0.01"></p-inputNumber>
                  <label>Custom</label>
                </p-floatLabel>
                <small *ngIf="variantFormSubmitted && customVariantPrice <= 0" class="p-error">
                  Prezzo obbligatorio
                </small>
              </div>

              <div class="p-field p-col-12 p-md-1">
                <p-button [label]="editingVariantIndex >= 0 ? 'Aggiorna' : 'Aggiungi'" (onClick)="addVariant()"
                  [disabled]="!newVariant.longName.trim() || (isCustomPricingMode() && customVariantPrice <= 0)"
                  [styleClass]="editingVariantIndex >= 0 ? 'p-button-success' : 'variant-add-btn'">
                </p-button>

              </div>
            </div>

            <p-table [value]="variants" *ngIf="variants.length" [paginator]="true" [rows]="5" class="p-mt-3">
              <ng-template pTemplate="header">
                <tr>
                  <th>Nome</th>
                  <th>Modalità</th>
                  <th>Prezzo</th>
                  <th>Posti</th>
                  <th>Larghezza</th>
                  <th>Azioni</th>
                </tr>
              </ng-template>
              <ng-template pTemplate="body" let-variant let-i="rowIndex">
                <tr>
                  <td>{{ variant.longName }}</td>
                  <td>
                    <span [class]="variant.pricingMode === 'custom' ? 'custom-mode-badge' : 'components-mode-badge'">
                      {{ variant.pricingMode === 'custom' ? 'Custom' : 'Componenti' }}
                    </span>
                  </td>
                  <td>
                    <span *ngIf="variant.pricingMode === 'custom'" class="custom-price">
                      {{ variant.price | currency:'EUR' }}
                    </span>
                    <span *ngIf="variant.pricingMode === 'components'" class="components-price">
                      {{ variant.price | currency:'EUR' }}
                      <small *ngIf="!variant.hasComponents()" class="p-text-secondary"> (da configurare)</small>
                    </span>
                  </td>
                  <td>{{ variant.seatsCount || "N/A" }}</td>
                  <td>{{ variant.mattressWidth ? variant.mattressWidth + " cm" : "N/A" }}</td>
                  <td>
                    <p-button type="button" icon="pi pi-pencil"
                      styleClass="p-button-rounded p-button-text p-button transparent-icon-btn"
                      (click)="editVariant(i)">
                    </p-button>
                    <p-button type="button" icon="pi pi-trash"
                      styleClass="p-button-rounded p-button-text p-button transparent-red-icon"
                      (click)="deleteVariant(i)">
                    </p-button>
                  </td>
                </tr>
              </ng-template>
            </p-table>
          </div>
        </ng-container>

        <!-- Step 3: Componenti -->
        <ng-container *ngIf="currentStep === 2">
          <div class="p-field p-col-12">
            <h3>Componenti</h3>

            <!-- Variant selection section -->
            <div class="p-field p-mb-4">
              <div class="p-grid">
                <div class="p-col-12 p-md-6" style="padding-top: 10px;">
                  <p-floatLabel>
                    <p-dropdown [options]="variants" [(ngModel)]="selectedVariant" optionLabel="longName"
                      inputId="variantDropdown" placeholder="Scegli una variante"
                      (onChange)="selectVariantForComponents($event.value)" [style]="{ width: '100%' }">
                      <ng-template let-variant pTemplate="item">
                        {{ variant.longName }} 
                        <span class="variant-mode-indicator">
                          ({{ variant.pricingMode === 'custom' ? 'Custom' : 'Componenti' }})
                        </span>
                      </ng-template>
                    </p-dropdown>
                    <label for="variantDropdown">Scegli una variante</label>
                  </p-floatLabel>
                </div>
              </div>
            </div>

            <!-- Custom Price Warning -->
            <div *ngIf="shouldShowCustomPriceWarning()" class="custom-price-warning p-mb-4">
              <p-message severity="info" 
                text="Questa variante utilizza un prezzo custom. I componenti sono opzionali."></p-message>
            </div>

            <!-- Components Section - only show for components mode -->
            <div *ngIf="shouldShowComponentsSection()" class="special-components p-mt-4">

              <!-- Fusto -->
              <div class="p-field p-grid" style="padding-top: 10px;">
                <div class="p-col-12 p-md-6">
                  <p-floatLabel>
                    <p-dropdown [options]="getComponentsByType('fusto') || []" [(ngModel)]="selectedFusto"
                      optionLabel="name" inputId="fustoDropdown" placeholder="Seleziona Fusto" [showClear]="true"
                      [disabled]="(getComponentsByType('fusto') || []).length === 0"
                      (onChange)="onComponentSelected('fusto', $event.value)" name="fusto" filter="true"
                      [ngStyle]="{ 'width': '100%' }">
                      <ng-template let-item pTemplate="item">
                        {{ formatComponentName(item) }}
                      </ng-template>
                      <ng-template let-selectedItem pTemplate="selectedItem">
                        {{ formatComponentName(selectedItem) }}
                      </ng-template>
                    </p-dropdown>
                    <label for="fustoDropdown">Fusto <span class="required-field"></span></label>
                  </p-floatLabel>
                  <small *ngIf="(getComponentsByType('fusto') || []).length === 0" class="p-error">
                    Nessun componente di tipo fusto disponibile
                  </small>
                </div>

              </div>

              <!-- Gomma -->
              <div class="p-field p-grid" style="padding-top: 10px;">
                <div class="p-col-12 p-md-6">
                  <p-floatLabel>
                    <p-dropdown [options]="getComponentsByType('gomma') || []" [(ngModel)]="selectedGomma"
                      optionLabel="name" inputId="gommaDropdown" placeholder="Seleziona Gomma" [showClear]="true"
                      [disabled]="(getComponentsByType('gomma') || []).length === 0"
                      (onChange)="onComponentSelected('gomma', $event.value)" name="gomma" filter="true"
                      [ngStyle]="{ 'width': '100%' }">
                      <ng-template let-item pTemplate="item">
                        {{ formatComponentName(item) }}
                      </ng-template>
                      <ng-template let-selectedItem pTemplate="selectedItem">
                        {{ formatComponentName(selectedItem) }}
                      </ng-template>
                    </p-dropdown>
                    <label for="gommaDropdown">Gomma <span class="required-field"></span></label>
                  </p-floatLabel>

                  <small *ngIf="(getComponentsByType('gomma') || []).length === 0" class="p-error">
                    Nessun componente di tipo gomma disponibile
                  </small>
                </div>
              </div>


              <!-- Rete -->
              <div class="p-field p-grid" style="padding-top: 10px;">
                <div class="p-col-12 p-md-6">
                  <p-floatLabel>
                    <p-dropdown [options]="getComponentsByType('rete') || []" [(ngModel)]="selectedRete"
                      optionLabel="name" inputId="reteDropdown" placeholder="Seleziona Rete" [showClear]="true"
                      [disabled]="(getComponentsByType('rete') || []).length === 0"
                      (onChange)="onComponentSelected('rete', $event.value)" name="rete" filter="true"
                      [ngStyle]="{ 'width': '100%' }">
                      <ng-template let-item pTemplate="item">
                        {{ formatComponentName(item) }}
                      </ng-template>
                      <ng-template let-selectedItem pTemplate="selectedItem">
                        {{ formatComponentName(selectedItem) }}
                      </ng-template>
                    </p-dropdown>
                    <label for="reteDropdown">Rete <span class="required-field"></span></label>
                  </p-floatLabel>

                  <small *ngIf="(getComponentsByType('rete') || []).length === 0" class="p-error">
                    Nessun componente di tipo rete disponibile
                  </small>
                </div>
              </div>


              <!-- Piedini + Quantità -->
              <div class="p-field p-grid" style="padding-top: 10px;">
                <div class="p-col-12 p-md-6 p-d-flex p-jc-between">
                  <!-- Selezione Piedini -->
                  <div class="p-mr-2" style="width: 70%;">
                    <p-floatLabel>
                      <p-dropdown [options]="getComponentsByType('piedini')" [(ngModel)]="selectedPiedini"
                        optionLabel="name" inputId="piediniDropdown" placeholder="Scegli Piedini" [showClear]="true"
                        [disabled]="getComponentsByType('piedini').length === 0"
                        (onChange)="onComponentSelected('piedini', $event.value)" name="piedini" filter="true"
                        [ngStyle]="{ 'width': '100%' }">
                        <ng-template let-item pTemplate="item">
                          {{ formatComponentName(item) }}
                        </ng-template>
                        <ng-template let-selectedItem pTemplate="selectedItem">
                          {{ formatComponentName(selectedItem) }}
                        </ng-template>
                      </p-dropdown>
                      <label for="piediniDropdown">
                        Piedini<span class="required-field"></span>
                      </label>
                    </p-floatLabel>
                    <small *ngIf="getComponentsByType('piedini').length === 0" class="p-error">
                      Nessun componente di tipo piedini disponibile
                    </small>
                  </div>

                  <!-- Quantità Piedini -->
                  <div style="width: 28%; padding-top: 30px;">
                    <p-floatLabel>
                      <p-dropdown [options]="piediniQuantityOptions" [(ngModel)]="piediniQty"
                        inputId="piediniQtyDropdown" placeholder="Quantità" name="piediniQty"
                        [disabled]="getComponentsByType('piedini').length === 0"
                        [ngStyle]="{ 'width': '100%' }"></p-dropdown>
                      <label for="piediniQtyDropdown">Quantità</label>
                    </p-floatLabel>
                  </div>
                </div>
              </div>


              <!-- Materasso -->
              <div class="p-field p-grid" style="padding-top: 10px;">
                <div class="p-col-12 p-md-6">
                  <p-floatLabel>
                    <p-dropdown [options]="getComponentsByType('materasso') || []" [(ngModel)]="selectedMaterasso"
                      optionLabel="name" inputId="materassoDropdown" placeholder="Seleziona Materasso"
                      [showClear]="true" [disabled]="(getComponentsByType('materasso') || []).length === 0"
                      (onChange)="onComponentSelected('materasso', $event.value)" name="materasso" filter="true"
                      [ngStyle]="{ 'width': '100%' }">
                      <ng-template let-item pTemplate="item">
                        {{ formatComponentName(item) }}
                      </ng-template>
                      <ng-template let-selectedItem pTemplate="selectedItem">
                        {{ formatComponentName(selectedItem) }}
                      </ng-template>
                    </p-dropdown>
                    <label for="materassoDropdown">
                      Materasso <span class="required-field"></span>
                    </label>
                  </p-floatLabel>

                  <small *ngIf="(getComponentsByType('materasso') || []).length === 0" class="p-error">
                    Nessun componente di tipo materasso disponibile
                  </small>
                </div>
              </div>


              <!-- Tappezzeria -->
              <div class="p-field p-grid" style="padding-top: 10px;">
                <div class="p-col-12 p-md-6">
                  <p-floatLabel>
                    <p-multiSelect [options]="getComponentsByType('tappezzeria')" [(ngModel)]="tappezzeriaList"
                      optionLabel="name" inputId="tappezzeriaSelect" placeholder="Scegli Tappezzeria"
                      name="tappezzeriaList" filter="true" [disabled]="getComponentsByType('tappezzeria').length === 0"
                      [ngStyle]="{ 'width': '100%' }">
                      <ng-template let-item pTemplate="item">
                        {{ formatComponentName(item) }}
                      </ng-template>
                      <ng-template let-selectedItem pTemplate="selectedItem">
                        {{ formatComponentName(selectedItem) }}
                      </ng-template>
                    </p-multiSelect>
                    <label for="tappezzeriaSelect">Tappezzeria</label>
                  </p-floatLabel>
                  <small *ngIf="getComponentsByType('tappezzeria').length === 0" class="p-error">
                    Nessun componente di tipo tappezzeria disponibile
                  </small>
                </div>
              </div>


              <!-- Ferramenta (multi-select) -->
              <div class="p-field p-grid" style="padding-top: 10px;">
                <div class="p-col-12 p-md-6">
                  <p-floatLabel>
                    <p-multiSelect [options]="getComponentsByType('ferramenta')" [(ngModel)]="ferramentaList"
                      optionLabel="name" inputId="ferramentaSelect" placeholder="Scegli Ferramenta"
                      name="ferramentaList" filter="true" [disabled]="getComponentsByType('ferramenta').length === 0"
                      [ngStyle]="{ 'width': '100%' }"></p-multiSelect>
                    <label for="ferramentaSelect">Ferramenta</label>
                  </p-floatLabel>
                  <small *ngIf="getComponentsByType('ferramenta').length === 0" class="p-error">
                    Nessun componente di tipo ferramenta disponibile
                  </small>
                </div>
              </div>


              <!-- Imballo -->
              <div class="p-field p-grid" style="padding-top: 10px;">
                <div class="p-col-12 p-md-6">
                  <p-floatLabel>
                    <p-dropdown [options]="getComponentsByType('imballo')" [(ngModel)]="selectedImballo"
                      optionLabel="name" inputId="imballoDropdown" placeholder="Seleziona Imballo" [showClear]="true"
                      [disabled]="getComponentsByType('imballo').length === 0"
                      (onChange)="onComponentSelected('imballo', $event.value)" name="imballo" filter="true"
                      [ngStyle]="{ 'width': '100%' }"></p-dropdown>
                    <label for="imballoDropdown">
                      Imballo <span class="required-field"></span>
                    </label>
                  </p-floatLabel>
                  <small *ngIf="getComponentsByType('imballo').length === 0" class="p-error">
                    Nessun componente di tipo imballo disponibile
                  </small>
                </div>
              </div>


              <!-- Scatola -->
              <div class="p-field p-grid" style="padding-top: 10px;">
                <div class="p-col-12 p-md-6">
                  <p-floatLabel>
                    <p-dropdown [options]="getComponentsByType('scatola')" [(ngModel)]="selectedScatola"
                      optionLabel="name" inputId="scatolaDropdown" placeholder="Seleziona Scatola" [showClear]="true"
                      [disabled]="getComponentsByType('scatola').length === 0"
                      (onChange)="onComponentSelected('scatola', $event.value)" name="scatola" filter="true"
                      [ngStyle]="{ 'width': '100%' }"></p-dropdown>
                    <label for="scatolaDropdown">
                      Scatola <span class="required-field"></span>
                    </label>
                  </p-floatLabel>
                  <small *ngIf="getComponentsByType('scatola').length === 0" class="p-error">
                    Nessun componente di tipo scatola disponibile
                  </small>
                </div>
              </div>


              <!-- Tela Marchiata -->
              <div class="p-field p-grid" style="padding-top: 10px;">
                <div class="p-col-12 p-md-6">
                  <p-floatLabel>
                    <p-dropdown [options]="getComponentsByType('tela_marchiata')" [(ngModel)]="selectedTelaMarchiata"
                      optionLabel="name" inputId="telaMarchiataDropdown" placeholder="Seleziona Tela Marchiata"
                      [showClear]="true" [disabled]="getComponentsByType('tela_marchiata').length === 0"
                      (onChange)="onComponentSelected('tela_marchiata', $event.value)" name="telaMarchiata"
                      filter="true" [ngStyle]="{ 'width': '100%' }">
                      <ng-template let-item pTemplate="item">
                        {{ formatComponentName(item) }}
                      </ng-template>
                      <ng-template let-selectedItem pTemplate="selectedItem">
                        {{ formatComponentName(selectedItem) }}
                      </ng-template>
                    </p-dropdown>
                    <label for="telaMarchiataDropdown">Tela Marchiata</label>
                  </p-floatLabel>

                  <small *ngIf="getComponentsByType('tela_marchiata').length === 0" class="p-error">
                    Nessun componente di tipo tela marchiata disponibile
                  </small>
                </div>
              </div>


              <!-- Trasporto -->
              <div class="p-field p-grid" style="padding-top: 10px;">
                <div class="p-col-12 p-md-6">
                  <p-floatLabel>
                    <p-dropdown [options]="getComponentsByType('trasporto')" [(ngModel)]="selectedTrasporto"
                      optionLabel="name" inputId="trasportoDropdown" placeholder="Seleziona Trasporto"
                      [showClear]="true" [disabled]="getComponentsByType('trasporto').length === 0"
                      (onChange)="onComponentSelected('trasporto', $event.value)" name="trasporto" filter="true"
                      [ngStyle]="{ 'width': '100%' }">
                      <ng-template let-item pTemplate="item">
                        {{ formatComponentName(item) }}
                      </ng-template>
                      <ng-template let-selectedItem pTemplate="selectedItem">
                        {{ formatComponentName(selectedItem) }}
                      </ng-template>
                    </p-dropdown>
                    <label for="trasportoDropdown">Trasporto</label>
                  </p-floatLabel>
                  <small *ngIf="getComponentsByType('trasporto').length === 0" class="p-error">
                    Nessun componente di tipo trasporto disponibile
                  </small>
                </div>
              </div>


              <!-- Varie (opzionale) -->
              <div class="p-field p-grid" style="padding-top: 10px;">
                <div class="p-col-12 p-md-6">
                  <p-floatLabel>
                    <p-multiSelect [options]="getComponentsByType('varie')" [(ngModel)]="varieList" optionLabel="name"
                      inputId="varieSelect" placeholder="Seleziona eventuali extra" name="varieList" filter="true"
                      [disabled]="getComponentsByType('varie').length === 0"
                      [ngStyle]="{ 'width': '100%' }"></p-multiSelect>
                    <label for="varieSelect">Varie</label>
                  </p-floatLabel>
                  <small *ngIf="getComponentsByType('varie').length === 0" class="p-error">
                    Nessun componente di tipo varie disponibile
                  </small>
                </div>
              </div>


              <!-- Pulsante di conferma -->
              <div class="p-field p-col-12">
                <div class="p-grid">

                  <div class="p-col-12 p-md-4 p-text-right">


                    <!-- Cambiato per abilitare il pulsante quando almeno un componente è selezionato -->
                    <p-button label="Applica componenti" icon="pi pi-check" (onClick)="applySpecialComponents()"
                      [disabled]="!hasSelectedComponents()" styleClass="variant-add-btn">
                    </p-button>

                  </div>
                </div>
              </div>

              <!-- Tabella componenti aggiunti alla variante -->
              <div class="p-field p-col-12" *ngIf="selectedVariant && selectedVariant.components.length > 0">
                <p-divider></p-divider>
                <h4>Componenti applicati a "{{ selectedVariant.longName }}"</h4>
                <p-table [value]="getGroupedComponents()">
                  <ng-template pTemplate="header">
                    <tr>
                      <th>Nome</th>
                      <th>Tipo</th>
                      <th>Prezzo</th>
                      <th>Quantità</th>
                    </tr>
                  </ng-template>
                  <ng-template pTemplate="body" let-row>
                    <tr>
                      <td>{{ formatComponentName(row.item) }}</td>
                      <td>{{ getComponentTypeDisplayName(row.item.type) }}</td>
                      <td>{{ row.item.price | currency:'EUR' }}</td>
                      <td>{{ row.qty }}</td>
                    </tr>
                  </ng-template>
                  <ng-template pTemplate="footer">
                    <tr>
                      <td colspan="2"><strong>Prezzo Totale:</strong></td>
                      <td colspan="2"><strong>{{ selectedVariant.price | currency:'EUR' }}</strong></td>
                    </tr>
                  </ng-template>
                </p-table>

              </div>
            </div>
          </div>
        </ng-container>

        <!-- Save product button -->
        <div class="p-field p-col-12" *ngIf="currentStep === 2">
          <p-divider></p-divider>

          <div class="p-text-center p-mt-4">
            <p-button label="Salva Prodotto" icon="pi pi-save" (onClick)="saveProduct()" [disabled]="isSavingProduct"
              [loading]="isSavingProduct" styleClass="p-button-primary">
            </p-button>

          </div>
        </div>

        <!-- Navigation buttons -->
        <div class="p-col-12">
          <p-divider class="p-mt-4"></p-divider>
          <div class="p-d-flex p-jc-between p-mt-3">
            <p-button *ngIf="currentStep > 0" label="Indietro" (onClick)="prevStep()  " styleClass="p-button-outlined"
              [disabled]="isSavingProduct || isUploading"></p-button>

            <p-button *ngIf="currentStep < steps.length - 1" label="Avanti" (onClick)="nextStep()"
              styleClass="p-button-primary" [disabled]="isSavingProduct || isUploading"
              [loading]="isUploading && currentStep === 0"></p-button>
          </div>
        </div>
      </form>
    </p-card>
  </div>

  <!-- Add Supplier Dialog -->
  <p-dialog [(visible)]="showAddSupplierDialog" header="Aggiungi Nuovo Fornitore" [modal]="true"
    [style]="{ width: '450px' }" [closable]="false">
    <div class="p-fluid">
      <div class="p-field">
        <label for="supplierName">Nome Fornitore</label>
        <input id="supplierName" type="text" pInputText [(ngModel)]="newSupplier.name" required />
        <small *ngIf="!newSupplier.name?.trim()" class="p-error">Campo obbligatorio</small>
      </div>

      <div class="p-field">
        <label for="supplierContact">Contatto</label>
        <input id="supplierContact" type="text" pInputText [(ngModel)]="newSupplier.contact" />
        <small>Email o telefono del fornitore</small>
      </div>
    </div>

    <ng-template pTemplate="footer">
      <p-button icon="pi pi-times" label="Annulla" (onClick)="cancelAddSupplier()" styleClass="p-button-text">
      </p-button>
      <p-button icon="pi pi-check" label="Salva" (onClick)="saveSupplier()" [disabled]="!newSupplier.name.trim()">
      </p-button>
    </ng-template>
  </p-dialog>

  <p-confirmDialog header="Conferma" icon="pi pi-exclamation-triangle" [closable]="false"></p-confirmDialog>

  <!-- Dialog Seduta -->
  <p-dialog header="Seduta" [(visible)]="showSedutaDialog" [modal]="true" [style]="{ width: '400px' }"
    [closable]="false">
    <div class="p-fluid">
      <div class="p-field">
        <label for="sedutaInput">Descrizione Seduta</label>
        <textarea id="sedutaInput" pInputTextarea [(ngModel)]="newSofaProduct.seduta" rows="3"
          placeholder="Inserisci la descrizione della seduta" name="sedutaDesc"></textarea>
      </div>
    </div>
    <ng-template pTemplate="footer">
      <p-button label="Salva" icon="pi pi-check" (onClick)="showSedutaDialog = false"></p-button>
    </ng-template>
  </p-dialog>

  <!-- Dialog Schienale -->
  <p-dialog header="Schienale" [(visible)]="showSchienaleDialog" [modal]="true" [style]="{ width: '400px' }"
    [closable]="false">
    <div class="p-fluid">
      <div class="p-field">
        <label for="schienaleInput">Descrizione Schienale</label>
        <textarea id="schienaleInput" pInputTextarea [(ngModel)]="newSofaProduct.schienale" rows="3"
          placeholder="Inserisci la descrizione dello schienale" name="schienaleDesc"></textarea>
      </div>
    </div>
    <ng-template pTemplate="footer">
      <p-button label="Salva" icon="pi pi-check" (onClick)="showSchienaleDialog = false"></p-button>
    </ng-template>
  </p-dialog>

  <!-- Dialog Meccanica -->
  <p-dialog header="Meccanica" [(visible)]="showMeccanicaDialog" [modal]="true" [style]="{ width: '400px' }"
    [closable]="false">
    <div class="p-fluid">
      <div class="p-field">
        <label for="meccanicaInput">Descrizione Meccanica</label>
        <textarea id="meccanicaInput" pInputTextarea [(ngModel)]="newSofaProduct.meccanica" rows="3"
          placeholder="Inserisci la descrizione della meccanica" name="meccanicaDesc"></textarea>
      </div>
    </div>
    <ng-template pTemplate="footer">
      <p-button label="Salva" icon="pi pi-check" (onClick)="showMeccanicaDialog = false"></p-button>
    </ng-template>
  </p-dialog>

  <!-- Dialog Materasso -->
  <p-dialog header="Materasso" [(visible)]="showMaterassoDialog" [modal]="true" [style]="{ width: '400px' }"
    [closable]="false">
    <div class="p-fluid">
      <div class="p-field">
        <label for="materassoInput">Descrizione Materasso</label>
        <textarea id="materassoInput" pInputTextarea [(ngModel)]="newSofaProduct.materasso" rows="3"
          placeholder="Inserisci la descrizione del materasso" name="materassoDesc"></textarea>
      </div>
    </div>
    <ng-template pTemplate="footer">
      <p-button label="Salva" icon="pi pi-check" (onClick)="showMaterassoDialog = false"></p-button>
    </ng-template>
  </p-dialog>
</div>