<div class="gestione-componenti-container">
  <p-toast></p-toast>

  <!-- Header pagina -->
  <div class="page-header">
    <h1>Gestione Componenti</h1>
    <p>Gestisci i componenti del catalogo prodotti</p>
  </div>

  <!-- Scheda form componente -->
  <div class="component-form-card" [ngClass]="{ 'editing-mode': isEditing }">
    <h2>{{ formTitle }}</h2>
    <form class="component-form" #componentForm="ngForm">
      <!-- Prima riga: fornitore e tipo -->
      <div class="form-row">
        <div class="form-group">
          <label for="componentSuppliers">Fornitore</label>
            <p-dropdown
            id="componentSuppliers"
            [options]="availableSuppliers"
            [(ngModel)]="selectedSupplier"
            name="supplier"
            optionLabel="name"
            placeholder="Seleziona fornitore (opzionale)"
            [showClear]="true"
            class="w-100"
            (onChange)="onSupplierChange($event)"
          ></p-dropdown>
        </div>

        <div class="form-group">
          <label for="componentType">Tipo Componente <span class="required-field">*</span></label>
          <p-dropdown
            id="componentType"
            [options]="availableComponentTypes"
            [(ngModel)]="selectedComponentType"
            name="componentType"
            optionLabel="label"
            optionValue="value"
            placeholder="Seleziona tipo"
            [showClear]="true"
            class="w-100"
            (onChange)="onComponentTypeChange($event)"
            [ngModelOptions]="{standalone: true}"
            [class.ng-invalid]="shouldShowComponentTypeError()"
          ></p-dropdown>
          <small *ngIf="shouldShowComponentTypeError()" class="p-error">
            Il tipo di componente è obbligatorio
          </small>
        </div>
      </div>

      <!-- Seconda riga: nome e prezzo -->
      <div class="form-row">
        <div class="form-group">
          <label for="componentName">
            Nome Componente <span class="required-field">*</span>
          </label>
          <input
            pInputText
            id="componentName"
            type="text"
            [(ngModel)]="newComponent.name"
            name="name"
            placeholder="Nome del componente"
            [class.ng-invalid]="shouldShowFieldError(newComponent.name)"
          />
          <small *ngIf="shouldShowFieldError(newComponent.name)" class="p-error">
            Il nome del componente è obbligatorio
          </small>
          <small *ngIf="!isEditing && (selectedComponentType || selectedSupplier)" class="field-hint">
            Il nome viene generato automaticamente in base al tipo e fornitore selezionati
          </small>
        </div>

        <div class="form-group">
          <label for="componentPrice">
            Prezzo <span class="required-field">*</span> (€)
          </label>
          <p-inputNumber
            id="componentPrice"
            [(ngModel)]="newComponent.price"
            name="price"
            [minFractionDigits]="2"
            [maxFractionDigits]="2"
            mode="currency"
            currency="EUR"
            locale="it-IT"
            [class.ng-invalid]="shouldShowPriceError()"
          ></p-inputNumber>
          <small *ngIf="shouldShowPriceError()" class="p-error">
            Il prezzo non può essere negativo
          </small>
        </div>
      </div>

      <!-- Azioni form -->
      <div class="form-actions">
        <p-button
          [label]="submitButtonLabel"
          (onClick)="addComponent()"
          styleClass="primary-button"
        ></p-button>
        <p-button
          *ngIf="isEditing"
          label="Annulla"
          (onClick)="resetForm()"
          styleClass="secondary-button"
        ></p-button>
      </div>
    </form>
  </div>

  <!-- Tabella dei componenti -->
  <div class="component-table-section">
    <h3>Lista Componenti</h3>

    <div *ngIf="loading" class="loading-message">
      <i class="pi pi-spin pi-spinner" style="font-size: 2rem"></i>
      <p>Caricamento componenti...</p>
    </div>

    <p-table
      *ngIf="dataLoaded && !loading"
      #componentTable
      [value]="components"
      styleClass="p-datatable-sm components-table"
      [paginator]="true"
      [rows]="10"
      [globalFilterFields]="['name','price']"
      [rowHover]="true"
      #dt
    >
      <ng-template pTemplate="caption">
        <div class="table-header">
          <h4>Componenti ({{ components.length }})</h4>
          <div class="search-container">
            <input
              pInputText
              type="text"
              placeholder="Cerca componente..."
              (input)="onGlobalFilter($event, dt)"
            />
          </div>
        </div>
      </ng-template>

      <ng-template pTemplate="header">
        <tr>
          <th>Nome</th>
          <th>Prezzo</th>
          <th>Tipo</th>
          <th>Fornitore</th>
          <th>Azioni</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-component let-i="rowIndex">
        <tr>
          <td>{{ component.name }}</td>
          <td>{{ component.price | currency:'EUR' }}</td>
          <td>{{ getComponentTypeDisplayName(component.type) }}</td>
          <td>{{ component.supplier?.name || 'Nessuno' }}</td>
          <td class="actions-cell">
            <button
              pButton
              type="button"
              icon="pi pi-pencil"
              class="p-button-rounded p-button-text p-button-sm action-edit"
              (click)="editComponent(component, i)"
              pTooltip="Modifica"
            ></button>
            <button
              pButton
              type="button"
              icon="pi pi-trash"
              class="p-button-rounded p-button-danger p-button-text p-button-sm action-delete"
              (click)="deleteComponent(component)"
              pTooltip="Elimina"
            ></button>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="5" class="empty-message">Nessun componente trovato</td>
        </tr>
      </ng-template>
    </p-table>
  </div>

  <!-- Dialog per conferma eliminazione -->
  <p-confirmDialog header="Conferma" [closable]="false"></p-confirmDialog>
</div>