<div class="gestione-componenti-container">
  <p-toast></p-toast>

  <div class="page-header">
    <h1>Gestione Componenti</h1>
    <p>Gestisci i componenti del catalogo prodotti</p>
  </div>

  <p-tabView [(activeIndex)]="activeTabIndex" (onChange)="onTabChange($event.index)" class="component-mode-tabview">
    <!-- TAB SINGOLO -->
    <p-tabPanel header="Singolo">
      <div class="component-form-card" [ngClass]="{ 'editing-mode': isEditing }">
        <h2 style="padding-bottom: 20px;">{{ formTitle }}</h2>
        <form class="component-form" #componentForm="ngForm">
          <!-- Prima riga: fornitore e tipo -->
          <div class="form-row" style="padding-top: 20px;">
            <div class="form-group">
              <p-floatLabel>
                <p-dropdown id="componentSuppliers" [options]="availableSuppliers" [(ngModel)]="selectedSupplier"
                  name="supplier" optionLabel="name" [showClear]="true" class="w-100"
                  (onChange)="onSupplierChange($event)"></p-dropdown>
                <label for="componentSuppliers">Fornitore <span class="required-field">*</span></label>
              </p-floatLabel>
            </div>

            <div class="form-group">
              <p-floatLabel>
                <p-dropdown id="componentType" [options]="availableComponentTypes" [(ngModel)]="selectedComponentType"
                  name="componentType" optionLabel="label" optionValue="value" [showClear]="true" class="w-100"
                  (onChange)="onComponentTypeChange($event)" [ngModelOptions]="{standalone: true}"
                  [class.ng-invalid]="shouldShowComponentTypeError()"></p-dropdown>
                <label for="componentType">Tipo Componente <span class="required-field">*</span></label>
              </p-floatLabel>
              <small *ngIf="shouldShowComponentTypeError()" class="p-error">
                Il tipo di componente è obbligatorio
              </small>
            </div>
          </div>

          <!-- Seconda riga: nome e tipo divano -->
          <div class="form-row" style="padding-top: 20px;">
            <div class="form-group">
              <p-floatLabel>
                <input pInputText id="componentName" type="text" [(ngModel)]="newComponent.name" name="name"
                  [class.ng-invalid]="shouldShowFieldError(newComponent.name)" />
                <label for="componentName">
                  Nome Componente <span class="required-field">*</span>
                </label>
              </p-floatLabel>
              <small *ngIf="shouldShowFieldError(newComponent.name)" class="p-error">
                Il nome del componente è obbligatorio
              </small>

              <div class="field-hint">
                <i class="pi pi-info-circle info-icon"></i>
                Il nome viene generato automaticamente in base al tipo, fornitore e tipo divano
              </div>
            </div>

            <div class="form-group">
              <p-floatLabel>
                <p-dropdown id="componentSofaType" [options]="availableSofaTypes" [(ngModel)]="newComponent.sofaType"
                  name="sofaType" optionLabel="label" optionValue="value" [showClear]="true" class="w-100"
                  placeholder="Tipo divano" (onChange)="onSofaTypeChange($event)"></p-dropdown>
                <label for="componentSofaType">Tipo Divano</label>
              </p-floatLabel>
            </div>
          </div>

          <!-- Terza riga: prezzo -->
          <div class="form-row" style="padding-top: 20px;">
            <div class="form-group">
              <p-floatLabel>
                <p-inputNumber id="componentPrice" [(ngModel)]="newComponent.price" name="price" placeholder="0,00"
                  [minFractionDigits]="2" [maxFractionDigits]="2" mode="currency" currency="EUR" locale="it-IT"
                  [class.ng-invalid]="shouldShowPriceError()"></p-inputNumber>
                <label for="componentPrice">Prezzo <span class="required-field">*</span></label>
              </p-floatLabel>

              <small *ngIf="shouldShowPriceError()" class="p-error">
                Il prezzo non può essere negativo
              </small>
            </div>
          </div>

          <div class="form-actions">
            <p-button [label]="submitButtonLabel" (onClick)="addComponent()" styleClass="primary-button"
              [disabled]="saving" [loading]="saving"></p-button>
            <p-button *ngIf="isEditing" label="Annulla" (onClick)="resetForm()" styleClass="secondary-button"
              [disabled]="saving"></p-button>
          </div>
        </form>
      </div>
    </p-tabPanel>

    <!-- TAB MULTIPLO -->
    <p-tabPanel header="Multiplo">
      <div class="bulk-component-form-card">
        <h2>Creazione Multipla Componenti</h2>

        <div class="bulk-section fixed-data-section">
          <h3><i class="pi pi-lock"></i> Dati Comuni</h3>
          <p class="section-description">Questi dati saranno applicati a tutti i componenti</p>
          <div class="form-row" style="padding-top: 20px;">
            <div class="form-group">
              <p-floatLabel>
                <p-dropdown id="componentType" [options]="availableComponentTypes" [(ngModel)]="bulkFixedData.type"
                  name="componentType" optionLabel="label" optionValue="value" [showClear]="true" class="w-100"
                  placeholder="Tipo di componente" (onChange)="onBulkTypeChange($event)"
                  [ngModelOptions]="{ standalone: true }"
                  [class.ng-invalid]="shouldShowComponentTypeError()"></p-dropdown>
                <label for="componentType">
                  Tipo di componente <span class="required-field">*</span>
                </label>
              </p-floatLabel>

            </div>

            <div class="form-group">
              <p-floatLabel>
                <p-dropdown id="bulkSupplier" [options]="availableSuppliers" [(ngModel)]="bulkFixedData.supplier"
                  name="bulkSupplier" optionLabel="name" [showClear]="true" class="w-100"
                  (onChange)="onBulkSupplierChange($event)"></p-dropdown>
                <label for="bulkSupplier">Fornitore <span class="required-field">*</span></label>
              </p-floatLabel>
            </div>
          </div>
        </div>

        <div class="bulk-section variable-data-section">
          <div class="section-header">
            <h3><i class="pi pi-list"></i> Varianti ({{ bulkVariableData.length }})</h3>
          </div>
          <p class="section-description">Ogni variante creerà un componente separato con tipo divano e prezzo diversi</p>

          <div #variantEntriesContainer class="variable-entries">
            <div *ngFor="let variableData of bulkVariableData; let i = index" class="variable-entry"
              [attr.data-index]="i">
              <div class="entry-header">
                <h4>Variante {{ i + 1 }}</h4>
                <p-button *ngIf="bulkVariableData.length > 1" icon="pi pi-trash" (onClick)="removeVariableDataEntry(i)"
                  styleClass="p-button-danger p-button-text p-button-sm remove-entry-button"
                  pTooltip="Rimuovi variante"></p-button>
              </div>

              <div class="form-row" style="padding-top: 20px;">
                <div class="form-group">
                  <p-floatLabel>
                    <p-dropdown [id]="'bulkSofaType_' + i" [options]="availableSofaTypes"
                      [(ngModel)]="variableData.sofaType" [name]="'bulkSofaType_' + i" optionLabel="label"
                      optionValue="value" [showClear]="true" placeholder="Tipo divano"
                      (onChange)="onBulkSofaTypeChange(i)"></p-dropdown>
                    <label [for]="'bulkSofaType_' + i">Tipo Divano</label>
                  </p-floatLabel>
                </div>

                <div class="form-group">
                  <p-floatLabel>
                    <p-inputNumber [id]="'bulkPrice_' + i" [(ngModel)]="variableData.price" [name]="'bulkPrice_' + i"
                      [minFractionDigits]="2" [maxFractionDigits]="2" mode="currency" currency="EUR" locale="it-IT"
                      placeholder="0,00"
                      [class.ng-invalid]="shouldShowBulkVariablePriceError(variableData.price)"></p-inputNumber>
                    <label [for]="'bulkPrice_' + i">Prezzo <span class="required-field">*</span></label>
                  </p-floatLabel>
                  <small *ngIf="shouldShowBulkVariablePriceError(variableData.price)" class="p-error">
                    Il prezzo non può essere negativo
                  </small>
                </div>
              </div>

              <!-- Nome generato automaticamente per questa variante -->
              <div class="form-row" style="padding-top: 20px;">
                <div class="form-group">
                  <p-floatLabel>
                    <input pInputText [id]="'bulkName_' + i" type="text" [(ngModel)]="variableData.name"
                      [name]="'bulkName_' + i" [class.ng-invalid]="shouldShowBulkNameError(variableData.name)" />
                    <label [for]="'bulkName_' + i">Nome Componente <span class="required-field">*</span></label>
                  </p-floatLabel>
                  <small *ngIf="shouldShowBulkNameError(variableData.name)" class="p-error">
                    Il nome del componente è obbligatorio
                  </small>
                  <div class="field-hint" style="padding-top: 10px;">
                    <i class="pi pi-info-circle info-icon"></i>
                    Il nome viene generato automaticamente in base al tipo, fornitore e tipo divano
                  </div>
                </div>
              </div>
            </div>

            <!-- Pulsante spostato in fondo -->
            <div class="variant-actions-bottom">
              <p-button label="Aggiungi Variante" icon="pi pi-plus" (onClick)="addVariableDataEntry()"
                styleClass="add-variant-button" size="small"></p-button>
            </div>
          </div>

          <div class="bulk-form-actions">
            <p-button label="Salva Componenti" icon="pi pi-save" (onClick)="saveBulkComponents()"
              styleClass="primary-button" [loading]="saving" [disabled]="saving"></p-button>
            <p-button label="Reset" icon="pi pi-refresh" (onClick)="resetBulkForm()" styleClass="secondary-button"
              [disabled]="saving"></p-button>
          </div>

          <div class="bulk-preview-section" *ngIf="bulkFixedData.type && bulkFixedData.supplier">
            <h4><i class="pi pi-eye"></i> Anteprima Componenti ({{ getValidBulkVariants().length }})</h4>
            <div class="preview-list">
              <div *ngFor="let variableData of getValidBulkVariants(); let i = index" class="preview-item">
                <strong>{{ variableData.name }}</strong>
                <span class="preview-details">
                  - {{ getComponentTypeDisplayName(bulkFixedData.type) }}
                  - {{ bulkFixedData.supplier.name }}
                  <span *ngIf="variableData.sofaType"> - {{ getSofaTypeDisplayName(variableData.sofaType) }}</span>
                  - {{ variableData.price | currency:'EUR' }}
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </p-tabPanel>

    <!-- TAB PREZZO LISTINO -->
    <p-tabPanel header="Prezzo Listino">
      <div class="price-list-form-card">
        <h2>Aggiornamento Prezzi per Fornitore</h2>
        <p class="section-description">Modifica i prezzi di tutti i componenti di un fornitore applicando una percentuale di variazione</p>

        <div class="price-list-section">
          <div class="form-row" style="padding-top: 20px;">
            <div class="form-group">
              <p-floatLabel>
                <p-dropdown 
                  id="priceListSupplier" 
                  [options]="availableSuppliers" 
                  [(ngModel)]="priceListData.selectedSupplier"
                  name="priceListSupplier" 
                  optionLabel="name" 
                  [showClear]="true" 
                  class="w-100"
                  (onChange)="onPriceListSupplierChange($event)">
                </p-dropdown>
                <label for="priceListSupplier">Fornitore <span class="required-field">*</span></label>
              </p-floatLabel>
            </div>

            <div class="form-group">
              <p-floatLabel>
                <p-inputNumber 
                  id="pricePercentage" 
                  [(ngModel)]="priceListData.percentage" 
                  name="pricePercentage"
                  [minFractionDigits]="1" 
                  [maxFractionDigits]="2" 
                  suffix="%" 
                  [min]="-100"
                  [max]="1000"
                  placeholder="0.0"
                  (onInput)="onPercentageChange()">
                </p-inputNumber>
                <label for="pricePercentage">Variazione Percentuale <span class="required-field">*</span></label>
              </p-floatLabel>
              <div class="field-hint">
                <i class="pi pi-info-circle info-icon"></i>
                Valori positivi aumentano i prezzi, valori negativi li diminuiscono
              </div>
            </div>
          </div>

          <div *ngIf="priceListData.selectedSupplier && priceListData.percentage !== null" class="price-preview-section">
            <h3><i style="color: #007bff;" class="pi pi-eye"></i> Anteprima Modifiche</h3>
            <p class="preview-summary">
              Componenti da aggiornare: <strong style="color: #007bff;">{{ filteredComponentsForPriceList.length }}</strong>
              - Variazione: <strong style="color: #007bff;">{{ (priceListData.percentage !== null && priceListData.percentage > 0) ? '+' : '' }}{{ priceListData.percentage }}%</strong>
            </p>

            <div *ngIf="filteredComponentsForPriceList.length > 0" class="price-preview-table">
              <p-table 
                [value]="filteredComponentsForPriceList" 
                styleClass="p-datatable-sm price-preview-table"
                [paginator]="true"
                [rows]="5"
                [rowHover]="true">
                
                <ng-template pTemplate="header">
                  <tr>
                    <th>Nome Componente</th>
                    <th>Prezzo Attuale</th>
                    <th>Nuovo Prezzo</th>
                    <th>Differenza</th>
                  </tr>
                </ng-template>

                <ng-template pTemplate="body" let-component>
                  <tr>
                    <td>{{ component.name }}</td>
                    <td>{{ component.price | currency:'EUR' }}</td>
                    <td class="new-price">{{ calculateNewPrice(component.price) | currency:'EUR' }}</td>
                    <td [class]="getPriceDifferenceClass(component.price)">
                       {{ getPriceDifference(component.price) | currency:'EUR' }}
                    </td>
                  </tr>
                </ng-template>
              </p-table>
            </div>

            <div *ngIf="filteredComponentsForPriceList.length === 0" class="no-components-message">
              <i class="pi pi-info-circle"></i>
              <span>Nessun componente trovato per il fornitore selezionato</span>
            </div>
          </div>

          <div class="price-list-actions" *ngIf="priceListData.selectedSupplier && priceListData.percentage !== null && filteredComponentsForPriceList.length > 0">
            <p-button 
              label="Applica Modifiche" 
              icon="pi pi-check" 
              (onClick)="confirmPriceListUpdate()"
              styleClass="primary-button"
              [loading]="savingPriceList" 
              [disabled]="savingPriceList">
            </p-button>
            <p-button 
              label="Reset" 
              icon="pi pi-refresh" 
              (onClick)="resetPriceListForm()" 
              styleClass="secondary-button"
              [disabled]="savingPriceList">
            </p-button>
          </div>
        </div>
      </div>
    </p-tabPanel>
  </p-tabView>

  <div class="component-table-section">
    <h3>Lista Componenti</h3>

    <div *ngIf="loading" class="loading-message">
      <i class="pi pi-spin pi-spinner" style="font-size: 2rem"></i>
      <p>Caricamento componenti...</p>
    </div>

    <p-table
  *ngIf="dataLoaded && !loading"
  #componentTable
  [value]="componentsView"
  styleClass="p-datatable-sm components-table"
  [paginator]="true"
  [rows]="10"
  [globalFilterFields]="[
    'name',
    'priceText',
    'priceTextComma',
    'typeLabel',
    'sofaTypeLabel',
    'supplierName'
  ]"
  [rowHover]="true"
  #dt
>

  <ng-template pTemplate="header">
    <tr>
      <th pSortableColumn="name">
        Nome
        <p-sortIcon field="name"></p-sortIcon>
      </th>

      <th pSortableColumn="price">
        Prezzo
        <p-sortIcon field="price"></p-sortIcon>
      </th>

      <th pSortableColumn="typeLabel">
        Tipo
        <p-sortIcon field="typeLabel"></p-sortIcon>
      </th>

      <th pSortableColumn="sofaTypeLabel">
        Tipo Divano
        <p-sortIcon field="sofaTypeLabel"></p-sortIcon>
      </th>

      <th pSortableColumn="supplierName">
        Fornitore
        <p-sortIcon field="supplierName"></p-sortIcon>
      </th>

      <th>Azioni</th>
    </tr>
  </ng-template>

  <ng-template pTemplate="caption">
  <div class="table-header search-tab">
    <h4>Componenti ({{ componentsView.length }})</h4>

    <div class="search-container">
      <span class="p-input w-full">
        <input
          pInputText
          type="text"
          placeholder="Cerca Componenti"
          (input)="onGlobalFilter($event, dt)"
          class="w-full"
        />
      </span>
    </div>
  </div>
</ng-template>


  <ng-template pTemplate="body" let-component let-i="rowIndex">
    <tr>
      <td>{{ component.name }}</td>
      <td>{{ component.price | currency:'EUR' }}</td>
      <td>{{ component.typeLabel }}</td>
      <td>{{ component.sofaTypeLabel || '-' }}</td>
      <td>{{ component.supplierName }}</td>
      <td class="actions-cell">
        <p-button type="button" icon="pi pi-pencil"
                  styleClass="p-button-rounded p-button-text p-button transparent-icon-btn"
                  (click)="editComponent(component, i)" pTooltip="Modifica"></p-button>
        <p-button type="button" icon="pi pi-trash"
                  styleClass="p-button-rounded p-button-text p-button transparent-red-icon"
                  (click)="deleteComponent(component)" pTooltip="Elimina"></p-button>
      </td>
    </tr>
  </ng-template>
</p-table>

  </div>

  <p-dialog header="Conferma Eliminazione" [(visible)]="displayConfirmDelete" [modal]="true" [closable]="false"
    [style]="{ width: '600px', maxWidth: '95vw' }">
    <ng-container *ngIf="loadingDependencies; else loadedList">
      <div class="loading-list">
        <i class="pi pi-spin pi-spinner"></i>
        <span>Verifica utilizzo componente…</span>
      </div>
    </ng-container>

    <ng-template #loadedList>
      <ng-container *ngIf="componentDependentProducts.length > 0; else noDeps">
        <div class="component-usage-warning">
          <div class="warning-text">
            Questo componente è utilizzato nei seguenti prodotti:
          </div>
          <ul class="product-list">
            <li *ngFor="let name of componentDependentProducts" class="product-item">
              {{ name }}
            </li>
          </ul>
          <div class="field-hint">
            <i class="pi pi-info-circle info-icon"></i>
            <strong>
              Se procedi, questo componente verrà rimosso da tutti i prodotti elencati.
            </strong>
          </div>
        </div>
      </ng-container>

      <ng-template #noDeps>
        <p>Sei sicuro di voler eliminare il componente
          <strong>{{ componentToDelete?.name }}</strong>?
        </p>
      </ng-template>
    </ng-template>

    <ng-template pTemplate="footer">
      <button pButton type="button" label="No" icon="pi pi-times" class="btn-dialog-no"
        (click)="rejectDelete()"></button>
      <button pButton type="button" label="Sì" icon="pi pi-check" class="btn-dialog-yes" (click)="confirmDelete()"
        [disabled]="loadingDependencies" autofocus></button>
    </ng-template>
  </p-dialog>

  <p-dialog header="Conferma Aggiornamento Prezzi" [(visible)]="displayConfirmPriceUpdate" [modal]="true" [closable]="false"
    [style]="{ width: '600px', maxWidth: '95vw' }">
    <div class="price-update-confirmation">
      <p>Sei sicuro di voler aggiornare i prezzi di <strong>{{ filteredComponentsForPriceList.length }}</strong> componenti del fornitore <strong>{{ priceListData.selectedSupplier?.name }}</strong>?</p>
      
      <div class="update-summary">
        <div class="summary-item">
          <span class="label">Variazione:</span>
          <span style="color: #007bff;" class="value">{{ (priceListData.percentage !== null && priceListData.percentage > 0) ? '+' : '' }}{{ priceListData.percentage }}%</span>
        </div>
        <div class="summary-item">
          <span class="label">Componenti interessati:</span>
          <span style="color: #007bff;" class="value">{{ filteredComponentsForPriceList.length }}</span>
        </div>
      </div>

      <div class="field-hint">
        <i class="pi pi-exclamation-triangle" style="color: red;"></i>
        <strong>Questa operazione non può essere annullata.</strong>
      </div>
    </div>

    <ng-template pTemplate="footer">
      <button pButton type="button" label="Annulla" icon="pi pi-times" class="btn-dialog-no"
        (click)="rejectPriceUpdate()"></button>
      <button pButton type="button" label="Conferma" icon="pi pi-check" class="btn-dialog-yes" (click)="applyPriceListUpdate()"
        [disabled]="savingPriceList" autofocus></button>
    </ng-template>
  </p-dialog>

</div>
