<div class="gestione-componenti-container">
  <p-toast></p-toast>

  <div class="page-header">
    <h1>Gestione Componenti</h1>
    <p>Gestisci i componenti del catalogo prodotti</p>
  </div>

  <p-tabView [(activeIndex)]="activeTabIndex" (activeIndexChange)="onTabChange($event)" styleClass="component-mode-tabview">
    <!-- TAB SINGOLO -->
    <p-tabPanel header="Singolo">
      <div class="component-form-card" [ngClass]="{ 'editing-mode': isEditing }">
        <h2>{{ formTitle }}</h2>
        <form class="component-form" #componentForm="ngForm">
          <div class="form-row">
            <div class="form-group">
              <label for="componentName">
                Nome Componente <span class="required-field">*</span>
              </label>
              <input
                pInputText
                id="componentName"
                type="text"
                [(ngModel)]="newComponent.name"
                name="name"
                placeholder="Nome del componente"
                [class.ng-invalid]="shouldShowFieldError(newComponent.name)"
              />
              <small *ngIf="shouldShowFieldError(newComponent.name)" class="p-error">
                Il nome del componente è obbligatorio
              </small>
            </div>

            <div class="form-group">
              <label for="componentPrice">
                Prezzo <span class="required-field">*</span> (€)
              </label>
              <p-inputNumber
                id="componentPrice"
                [(ngModel)]="newComponent.price"
                name="price"
                [minFractionDigits]="2"
                [maxFractionDigits]="2"
                mode="currency"
                currency="EUR"
                locale="it-IT"
                [class.ng-invalid]="shouldShowPriceError()"
              ></p-inputNumber>
              <small *ngIf="shouldShowPriceError()" class="p-error">
                Il prezzo non può essere negativo
              </small>
            </div>
          </div>

            <div class="form-row">
              <div class="form-group">
                <label for="componentSuppliers">Fornitore</label>
                <p-dropdown
                  id="componentSuppliers"
                  [options]="availableSuppliers"
                  [(ngModel)]="selectedSupplier"
                  name="supplier"
                  optionLabel="name"
                  placeholder="Seleziona fornitore (opzionale)"
                  [showClear]="true"
                  class="w-100"
                ></p-dropdown>
              </div>

              <div class="form-group">
                <label for="componentType">Tipo di Componente</label>
                <p-dropdown
                  id="componentType"
                  [options]="availableComponentTypes"
                  [(ngModel)]="selectedComponentType"
                  name="componentType"
                  optionLabel="label"
                  optionValue="value"
                  placeholder="Seleziona tipo (opzionale)"
                  [showClear]="true"
                  class="w-100"
                  (onChange)="onComponentTypeChange($event)"
                ></p-dropdown>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="componentMeasure">Dimensioni</label>
                <input
                  pInputText
                  id="componentMeasure"
                  type="text"
                  [(ngModel)]="newComponent.measure"
                  name="measure"
                  placeholder="es: 120x80 cm"
                />
              </div>
            </div>

            <div class="form-actions">
              <p-button
                [label]="submitButtonLabel"
                (onClick)="addComponent()"
                styleClass="primary-button"
                [disabled]="saving"
                [loading]="saving"
              ></p-button>
              <p-button
                *ngIf="isEditing"
                label="Annulla"
                (onClick)="resetForm()"
                styleClass="secondary-button"
                [disabled]="saving"
              ></p-button>
            </div>
        </form>
      </div>
    </p-tabPanel>

    <!-- TAB MULTIPLO -->
    <p-tabPanel header="Multiplo">
      <div class="bulk-component-form-card">
        <h2>Creazione Multipla Componenti</h2>

        <div class="bulk-section fixed-data-section">
          <h3><i class="pi pi-lock"></i> Dati Comuni</h3>
          <p class="section-description">Questi dati saranno applicati a tutti i componenti</p>
          <div class="form-row">
            <div class="form-group">
              <label for="bulkComponentName">
                Nome Componente <span class="required-field">*</span>
              </label>
              <input
                pInputText
                id="bulkComponentName"
                type="text"
                [(ngModel)]="bulkFixedData.name"
                name="bulkName"
                placeholder="Nome comune per tutti i componenti"
                [class.ng-invalid]="shouldShowBulkFixedFieldError(bulkFixedData.name)"
              />
              <small *ngIf="shouldShowBulkFixedFieldError(bulkFixedData.name)" class="p-error">
                Il nome del componente è obbligatorio
              </small>
            </div>

            <div class="form-group">
              <label for="bulkComponentType">
                Tipo di Componente <span class="required-field">*</span>
              </label>
              <p-dropdown
                id="bulkComponentType"
                [options]="availableComponentTypes"
                [(ngModel)]="bulkFixedData.type"
                name="bulkType"
                optionLabel="label"
                optionValue="value"
                placeholder="Seleziona tipo"
                class="w-100"
              ></p-dropdown>
            </div>
          </div>
        </div>

        <div class="bulk-section variable-data-section">
          <div class="section-header">
            <h3><i class="pi pi-list"></i> Varianti ({{ bulkVariableData.length }})</h3>
          </div>
          <p class="section-description">Ogni variante creerà un componente separato</p>

          <div #variantEntriesContainer class="variable-entries">
            <div
              *ngFor="let variableData of bulkVariableData; let i = index"
              class="variable-entry"
              [attr.data-index]="i"
            >
              <div class="entry-header">
                <h4>Variante {{ i + 1 }}</h4>
                <p-button
                  *ngIf="bulkVariableData.length > 1"
                  icon="pi pi-trash"
                  (onClick)="removeVariableDataEntry(i)"
                  styleClass="p-button-danger p-button-text p-button-sm remove-entry-button"
                  pTooltip="Rimuovi variante"
                ></p-button>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label [for]="'bulkSupplier_' + i">Fornitore</label>
                  <p-dropdown
                    [id]="'bulkSupplier_' + i"
                    [options]="availableSuppliers"
                    [(ngModel)]="variableData.supplier"
                    [name]="'bulkSupplier_' + i"
                    optionLabel="name"
                    placeholder="Seleziona fornitore (opzionale)"
                    [showClear]="true"
                    class="w-100"
                  ></p-dropdown>
                </div>

                <div class="form-group">
                  <label [for]="'bulkMeasure_' + i">Dimensioni</label>
                  <input
                    pInputText
                    [id]="'bulkMeasure_' + i"
                    type="text"
                    [(ngModel)]="variableData.measure"
                    [name]="'bulkMeasure_' + i"
                    placeholder="es: 120x80 cm"
                  />
                </div>

                <div class="form-group">
                  <label [for]="'bulkPrice_' + i">
                    Prezzo <span class="required-field">*</span> (€)
                  </label>
                  <p-inputNumber
                    [id]="'bulkPrice_' + i"
                    [(ngModel)]="variableData.price"
                    [name]="'bulkPrice_' + i"
                    [minFractionDigits]="2"
                    [maxFractionDigits]="2"
                    mode="currency"
                    currency="EUR"
                    locale="it-IT"
                    [class.ng-invalid]="shouldShowBulkVariablePriceError(variableData.price)"
                  ></p-inputNumber>
                  <small *ngIf="shouldShowBulkVariablePriceError(variableData.price)" class="p-error">
                    Il prezzo non può essere negativo
                  </small>
                </div>
              </div>
            </div>
          </div>

          <!-- Pulsante spostato in fondo -->
          <div class="variant-actions-bottom">
            <p-button
              label="Aggiungi Variante"
              icon="pi pi-plus"
              (onClick)="addVariableDataEntry()"
              styleClass="add-variant-button"
              size="small"
            ></p-button>
          </div>
        </div>

        <div class="bulk-form-actions">
          <p-button
            label="Salva Tutti i Componenti"
            icon="pi pi-save"
            (onClick)="saveBulkComponents()"
            styleClass="primary-button"
            [loading]="saving"
            [disabled]="saving"
          ></p-button>
          <p-button
            label="Reset"
            icon="pi pi-refresh"
            (onClick)="resetBulkForm()"
            styleClass="secondary-button"
            [disabled]="saving"
          ></p-button>
          <p-button
            label="Annulla"
            icon="pi pi-times"
            (onClick)="activeTabIndex = 0"
            styleClass="cancel-button"
            [disabled]="saving"
          ></p-button>
        </div>

        <div class="bulk-preview-section" *ngIf="bulkFixedData.name">
          <h4><i class="pi pi-eye"></i> Anteprima Componenti ({{ bulkVariableData.length }})</h4>
          <div class="preview-list">
            <div *ngFor="let variableData of bulkVariableData; let i = index" class="preview-item">
              <strong>{{ bulkFixedData.name }}</strong>
              <span class="preview-details">
                - {{ getComponentTypeDisplayName(bulkFixedData.type) }}
                <span *ngIf="variableData.supplier"> - {{ variableData.supplier.name }}</span>
                <span *ngIf="variableData.measure"> - {{ variableData.measure }}</span>
                - {{ variableData.price | currency:'EUR' }}
              </span>
            </div>
          </div>
        </div>
      </div>
    </p-tabPanel>
  </p-tabView>

  <div class="component-table-section">
    <h3>Lista Componenti</h3>

    <div *ngIf="loading" class="loading-message">
      <i class="pi pi-spin pi-spinner" style="font-size: 2rem"></i>
      <p>Caricamento componenti...</p>
    </div>

    <p-table
      *ngIf="dataLoaded && !loading"
      #componentTable
      [value]="components"
      styleClass="p-datatable-sm components-table"
      [paginator]="true"
      [rows]="10"
      [globalFilterFields]="['name','price']"
      [rowHover]="true"
      #dt
    >
      <ng-template pTemplate="caption">
        <div class="table-header">
          <h4>Componenti ({{ components.length }})</h4>
          <div class="search-container">
            <input
              pInputText
              type="text"
              placeholder="Cerca componente..."
              (input)="onGlobalFilter($event, dt)"
            />
          </div>
        </div>
      </ng-template>

      <ng-template pTemplate="header">
        <tr>
          <th>Nome</th>
            <th>Prezzo</th>
            <th>Tipo</th>
            <th>Dimensioni</th>
            <th>Azioni</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-component let-i="rowIndex">
        <tr>
          <td>{{ component.name }}</td>
          <td>{{ component.price | currency:'EUR' }}</td>
          <td>{{ getComponentTypeDisplayName(component.type) }}</td>
          <td>{{ component.measure || 'Non specificato' }}</td>
          <td class="actions-cell">
            <button
              pButton
              type="button"
              icon="pi pi-pencil"
              class="p-button-rounded p-button-text p-button-sm action-edit"
              (click)="editComponent(component, i)"
              pTooltip="Modifica"
              aria-label="Modifica componente"
            ></button>
            <button
              pButton
              type="button"
              icon="pi pi-trash"
              class="p-button-rounded p-button-danger p-button-text p-button-sm action-delete"
              (click)="deleteComponent(component)"
              pTooltip="Elimina"
              aria-label="Elimina componente"
            ></button>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="5" class="empty-message">Nessun componente trovato</td>
        </tr>
      </ng-template>
    </p-table>
  </div>

  <p-confirmDialog header="Conferma" [closable]="false"></p-confirmDialog>
</div>
